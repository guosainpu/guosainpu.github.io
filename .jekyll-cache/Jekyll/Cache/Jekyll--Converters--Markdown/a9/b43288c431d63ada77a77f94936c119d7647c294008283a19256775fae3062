I"³“<h3 id="ææ–™å‡†å¤‡">ææ–™å‡†å¤‡</h3>

<p>é¦–å…ˆæ‰‹å†™ä¸€ä¸ªç®€å•çš„Cç¨‹åºï¼šmain.c</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre></td><td class="rouge-code"><pre><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="kt">void</span> <span class="nf">empty</span><span class="p">();</span>
<span class="kt">int</span>  <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">j</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">myPrint</span><span class="p">(</span><span class="kt">int</span> <span class="n">num</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">testParams</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">d</span><span class="p">,</span> <span class="kt">int</span> <span class="n">e</span><span class="p">,</span> <span class="kt">int</span> <span class="n">f</span><span class="p">,</span> <span class="kt">int</span> <span class="n">g</span><span class="p">,</span> <span class="kt">int</span> <span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="kt">int</span> <span class="n">k</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="c1">// æµ‹è¯•ç©ºå‡½æ•°</span>
	<span class="n">empty</span><span class="p">();</span>

	<span class="c1">// æµ‹è¯•ä¼ 2ä¸ªå‚æ•°çš„å‡½æ•°</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

	<span class="c1">// æµ‹è¯•ä¼ å¤šä¸ªå‚æ•°çš„å‡½æ•°</span>
	<span class="n">testParams</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>

	<span class="c1">// æµ‹è¯•printå‡½æ•°ï¼ˆä¸å®šå‚æ•°ï¼‰</span>
	<span class="n">myPrint</span><span class="p">(</span><span class="n">k</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">empty</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">j</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">k</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">myPrint</span><span class="p">(</span><span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"%s %s %s: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"hello"</span><span class="p">,</span> <span class="s">"world"</span><span class="p">,</span> <span class="s">"print"</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">testParams</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">d</span><span class="p">,</span> <span class="kt">int</span> <span class="n">e</span><span class="p">,</span> <span class="kt">int</span> <span class="n">f</span><span class="p">,</span> <span class="kt">int</span> <span class="n">g</span><span class="p">,</span> <span class="kt">int</span> <span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="kt">int</span> <span class="n">k</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç„¶åæ‰§è¡Œ clang main.cï¼Œé»˜è®¤ç”Ÿæˆ a.out æ–‡ä»¶ã€‚æŸ¥çœ‹ a.outï¼Œå¯ä»¥çœ‹åˆ° a.out æ˜¯ä¸€ä¸ª x86_64 æ¶æ„ä¸‹çš„ Mach-O æ ¼å¼çš„æ–‡ä»¶ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>âœ  å‡½æ•°è°ƒç”¨è¿‡ç¨‹ git:(master) âœ— clang main.c
âœ  å‡½æ•°è°ƒç”¨è¿‡ç¨‹ git:(master) âœ— ls
a.out  main.c
âœ  å‡½æ•°è°ƒç”¨è¿‡ç¨‹ git:(master) âœ— file a.out 
a.out: Mach-O 64-bit executable x86_64
âœ  å‡½æ•°è°ƒç”¨è¿‡ç¨‹ git:(master) âœ— 
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="æŸ¥çœ‹mach-o">æŸ¥çœ‹Mach-O</h3>

<p>æˆ‘ä»¬ä½¿ç”¨å·¥å…·æ¥åˆ†æMach-Oæ–‡ä»¶ï¼š<a href="https://github.com/gdbinit/MachOView">MachOView</a></p>

<p>å±•å¼€æ®µï¼š__TEXT_textï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° main.c ä¸­æˆ‘ä»¬è‡ªå®šä¹‰çš„å‡½æ•°çš„ä»¥æ±‡ç¼–æŒ‡ä»¤çš„å½¢å¼é¡ºåºçš„æ’åˆ—åœ¨è¿™é‡Œã€‚
<img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gfubijrys3j30u01rc4c2.jpg" width="800" /></p>

<h3 id="rbp-å’Œ-rsp">RBP å’Œ RSP</h3>

<p>åˆ†æå‡½æ•°è°ƒç”¨è¿‡ç¨‹ï¼Œå…¶å®å°±æ˜¯åˆ†æç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­<strong>æŒ‡ä»¤çš„è·³è½¬å’Œæ ˆå†…å­˜åŒºåŸŸçš„å˜åŒ–</strong></p>

<p>åœ¨å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­æœ‰2ä¸ªéå¸¸é‡è¦çš„æŒ‡é’ˆå¯„å­˜å™¨ï¼š<strong>bp å’Œ sp</strong></p>
<ol>
  <li>bpå§‹ç»ˆæŒ‡å‘å½“å‰æœ€é¡¶éƒ¨çš„æ ˆå¸§çš„æ ˆåº•</li>
  <li>spæŒ‡å‘å½“å‰æœ€é¡¶éƒ¨çš„æ ˆå¸§çš„æ ˆé¡¶ï¼ˆåŸåˆ™ä¸Šæ˜¯éœ€è¦æŒ‡å‘æ ˆé¡¶ï¼Œä½†ç”±äºä»£ç ä¼˜åŒ–çš„åŸå› ï¼Œå¹¶ä¸æ˜¯æ€»æ˜¯ï¼‰</li>
</ol>

<center><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gfucqsz6rpj30hq0q20tk.jpg" width="300" /></center>

<h3 id="ç©ºå‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹">ç©ºå‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹</h3>

<p>æ¥ç€è®©æˆ‘ä»¬ç”¨debugçš„æ–¹å¼æ¥çœ‹ä¸‹ x86_64 ä¸‹å‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ã€‚é¦–å…ˆç¨‹åºä¼šå…ˆè¿›å…¥ main å‡½æ•°ï¼Œç„¶åè°ƒç”¨ empty å‡½æ•°ï¼Œempty å‡½æ•°éå¸¸ç®€å•ï¼Œä»€ä¹ˆéƒ½ä¸åšå°±é€€å‡ºäº†ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre>1 // è°ƒç”¨ lldb å¼€å§‹è°ƒè¯• a.out
âœ  å‡½æ•°è°ƒç”¨è¿‡ç¨‹ git:(master) âœ— lldb a.out 
(lldb) target create "a.out"
Current executable set to 'a.out' (x86_64).

2 // è®¾ç½®æ–­ç‚¹åˆ° main
(lldb) breakpoint set --name main 
Breakpoint 1: where = a.out`main, address = 0x0000000100000e20

3 // run ç¨‹åº
(lldb) run
Process 42767 launched: '/Users/guosai/practice_C/å‡½æ•°è°ƒç”¨è¿‡ç¨‹/a.out' (x86_64)
Process 42767 stopped

* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1
    frame #0: 0x0000000100000e20 a.out`main
a.out`main:
-&gt;  0x100000e20 &lt;+0&gt;: pushq  %rbp
    0x100000e21 &lt;+1&gt;: movq   %rsp, %rbp
    0x100000e24 &lt;+4&gt;: subq   $0x40, %rsp
    0x100000e28 &lt;+8&gt;: movl   $0x0, -0x4(%rbp)
Target 0: (a.out) stopped.
(lldb) 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œç¨‹åºåœç•™åœ¨äº† main å‡½æ•°çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ pushq    %rbpã€‚ç„¶åæˆ‘ä»¬å†æ¥åˆ†æçœ‹ä¸‹ main å‡½æ•°å’Œ empty å‡½æ•°çš„æ±‡ç¼–ä»£ç ï¼ˆç”¨ disassemble â€“name å‘½ä»¤ï¼‰</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre>a.out`main:
-&gt;  0x100000e20 &lt;+0&gt;:   pushq  %rbp
    0x100000e21 &lt;+1&gt;:   movq   %rsp, %rbp
    0x100000e24 &lt;+4&gt;:   subq   $0x40, %rsp
    0x100000e28 &lt;+8&gt;:   movl   $0x0, -0x4(%rbp)
    0x100000e2f &lt;+15&gt;:  callq  0x100000f60               ; empty
    0x100000e34 &lt;+20&gt;:  movl   $0x3, -0x8(%rbp)
    0x100000e3b &lt;+27&gt;:  movl   $0x4, -0xc(%rbp)
    0x100000e42 &lt;+34&gt;:  movl   -0x8(%rbp), %edi
    0x100000e45 &lt;+37&gt;:  movl   -0xc(%rbp), %esi
    0x100000e48 &lt;+40&gt;:  callq  0x100000eb0               ; add
    0x100000e4d &lt;+45&gt;:  movl   %eax, -0x10(%rbp)
    0x100000e50 &lt;+48&gt;:  movl   $0x1, %edi
    0x100000e55 &lt;+53&gt;:  movl   $0x2, %esi
    0x100000e5a &lt;+58&gt;:  movl   $0x3, %edx
    0x100000e5f &lt;+63&gt;:  movl   $0x4, %ecx
    0x100000e64 &lt;+68&gt;:  movl   $0x5, %r8d
    0x100000e6a &lt;+74&gt;:  movl   $0x6, %r9d
    0x100000e70 &lt;+80&gt;:  movl   $0x7, (%rsp)
    0x100000e77 &lt;+87&gt;:  movl   $0x8, 0x8(%rsp)
    0x100000e7f &lt;+95&gt;:  movl   $0x9, 0x10(%rsp)
    0x100000e87 &lt;+103&gt;: movl   $0xa, 0x18(%rsp)
    0x100000e8f &lt;+111&gt;: movl   $0xb, 0x20(%rsp)
    0x100000e97 &lt;+119&gt;: callq  0x100000ed0               ; testParams
    0x100000e9c &lt;+124&gt;: movl   -0x10(%rbp), %edi
    0x100000e9f &lt;+127&gt;: callq  0x100000f20               ; myPrint
    0x100000ea4 &lt;+132&gt;: xorl   %eax, %eax
    0x100000ea6 &lt;+134&gt;: addq   $0x40, %rsp
    0x100000eaa &lt;+138&gt;: popq   %rbp
    0x100000eab &lt;+139&gt;: retq   
    0x100000eac &lt;+140&gt;: nopl   (%rax)
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>a.out`empty:
    0x100000f60 &lt;+0&gt;: pushq  %rbp
    0x100000f61 &lt;+1&gt;: movq   %rsp, %rbp
    0x100000f64 &lt;+4&gt;: popq   %rbp
    0x100000f65 &lt;+5&gt;: retq   
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¦åˆ†æä¸€ä¸ªç©ºå‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ï¼Œä¸»è¦æ˜¯åˆ†æä¸€ä¸‹å‡ ä¸ªæŒ‡ä»¤ï¼ˆæˆ–æŒ‡ä»¤ç»„åˆï¼‰</p>

<table>
  <thead>
    <tr>
      <th>æŒ‡ä»¤ï¼ˆæŒ‡ä»¤ç»„åˆï¼‰</th>
      <th>ä½œç”¨</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>callq  æ•°å€¼</td>
      <td>è·³è½¬åˆ°æŸå‡½æ•°</td>
    </tr>
    <tr>
      <td>pushq  %rbp å’Œ movq   %rsp, %rbp</td>
      <td>æš‚å­˜bpæŒ‡é’ˆï¼Œå¹¶å¼€è¾Ÿæ–°çš„æ ˆå¸§</td>
    </tr>
    <tr>
      <td>popq   %rbp å’Œ retq</td>
      <td>å‡½æ•°ç»“æŸï¼Œè¿”å›ä¸Šä¸€çº§å‡½æ•°</td>
    </tr>
  </tbody>
</table>

<h4 id="callq">callq</h4>

<p>callq å°±æ˜¯ call æŒ‡ä»¤ï¼ˆqä»£è¡¨è¦å¤„ç†çš„å­—èŠ‚é•¿åº¦ï¼Œqæ˜¯8å­—èŠ‚ï¼Œlæ˜¯4å­—èŠ‚ï¼Œwæ˜¯2å­—èŠ‚ï¼‰ã€‚call æŒ‡ä»¤æŒ‡ç¤º CPU åº”è·³è½¬åˆ°æŸä¸ªåœ°å€å»æ‰§è¡Œæ–°çš„å‡½æ•°ã€‚</p>

<p>ç°åœ¨æˆ‘ä»¬æ‰§è¡Œ4æ¬¡stepæŒ‡ä»¤ï¼Œè®© CPU åœç•™åœ¨ç¬¬äº”æ¡æŒ‡ä»¤ä¸Šï¼šcallq  0x100000f60ï¼ˆå»è·³è½¬ empty å‡½æ•°ï¼‰ï¼Œåœ¨åˆ†æè¿™æ¡æŒ‡ä»¤ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ CPU ä¸­å„å¯„å­˜å™¨çš„çŠ¶æ€ï¼ˆregister read å‘½ä»¤ï¼‰</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre>a.out`main:
    0x100000e20 &lt;+0&gt;:   pushq  %rbp
    0x100000e21 &lt;+1&gt;:   movq   %rsp, %rbp
    0x100000e24 &lt;+4&gt;:   subq   $0x40, %rsp
    0x100000e28 &lt;+8&gt;:   movl   $0x0, -0x4(%rbp)
-&gt;  0x100000e2f &lt;+15&gt;:  callq  0x100000f60               ; empty
    0x100000e34 &lt;+20&gt;:  movl   $0x3, -0x8(%rbp)
    0x100000e3b &lt;+27&gt;:  movl   $0x4, -0xc(%rbp)
    ............

General Purpose Registers:
       rax = 0x0000000100000e20  a.out`main
       rbx = 0x0000000000000000
       rcx = 0x00007ffeefbff5a8
       rdx = 0x00007ffeefbff3a8
       rdi = 0x0000000000000001
       rsi = 0x00007ffeefbff398
       rbp = 0x00007ffeefbff370
       rsp = 0x00007ffeefbff330
        r8 = 0x0000000000000000
        r9 = 0x0000000000000000
       r10 = 0x0000000000000000
       r11 = 0x0000000000000000
       r12 = 0x0000000000000000
       r13 = 0x0000000000000000
       r14 = 0x0000000000000000
       r15 = 0x0000000000000000
       rip = 0x0000000100000e2f  a.out`main + 15
    rflags = 0x0000000000000206
        cs = 0x000000000000002b
        fs = 0x0000000000000000
        gs = 0x0000000000000000
</pre></td></tr></tbody></table></code></pre></div></div>

<center><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gfudzgrh42j31jq0i874t.jpg" width="800" /></center>

<p>å¯ä»¥çœ‹åˆ°æ­¤æ—¶ï¼š</p>
<ul>
  <li>rbp = 0x00007ffeefbff370ï¼Œmainæ ˆå¸§çš„æ ˆåº•çš„åœ°å€å°±æ˜¯ 0x00007ffeefbff370</li>
  <li>rsp = 0x00007ffeefbff330ï¼Œmainæ ˆå¸§çš„æ ˆé¡¶çš„åœ°å€å°±æ˜¯ 0x00007ffeefbff330ï¼ˆå› ä¸ºæ ˆæ˜¯å‘ä¸‹ç”Ÿé•¿çš„ï¼Œæ‰€ä»¥spå°äºdpï¼‰</li>
</ul>

<p>ç”±æ­¤å¯ä»¥ç®—å‡º main çš„æ ˆå¸§å çš„å†…å­˜ç©ºé—´å¤§å°æ˜¯ 0x40 ï¼Œæ­£å¥½ç¬¦åˆç¬¬ä¸‰æ¡æŒ‡ä»¤ï¼šsubq   $0x40, %rsp</p>

<ul>
  <li>rip æŒ‡å‘å½“å‰ç­‰å¾…æ‰§è¡Œçš„æŒ‡ä»¤çš„åœ°å€ï¼Œæ­¤æ—¶ rip = 0x0000000100000e2fï¼Œæ­£å¥½æ˜¯ï¼ˆ0x100000e2f &lt;+15&gt;:  callq  0x100000f60ï¼‰</li>
</ul>

<p>é‚£ä¹ˆ callq  0x100000f60 æŒ‡ä»¤åšäº†ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬é¦–å…ˆæŠ›å‡ºç»“è®ºï¼š</p>
<ol>
  <li>é¦–å…ˆ call æŒ‡ä»¤æŠŠå½“å‰æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ push å…¥æ ˆï¼ˆå…ˆæŠŠè¿™æ¡æŒ‡ä»¤çš„åœ°å€æš‚å­˜ä¸‹æ¥ï¼Œç­‰åé¢è¢«è°ƒç”¨å‡½æ•°è¿”å›çš„æ—¶å€™æ‰èƒ½æ‰¾åˆ°å®ƒï¼Œå¹¶ç»§ç»­æ‰§è¡Œï¼‰</li>
  <li>æ‰¾åˆ°ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤çš„åœ°å€ï¼ˆå³ empty çš„åœ°å€ï¼‰ï¼Œå¹¶è·³è½¬æ‰§è¡Œã€‚</li>
</ol>

<p>é¦–å…ˆæˆ‘ä»¬æ¥éªŒè¯ç¬¬2ç‚¹ï¼Œå½“å‰çš„è·³è½¬æŒ‡ä»¤æ˜¯ï¼šcallq  0x100000f60ï¼Œempty çš„ç¬¬ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ä¹Ÿæ˜¯ 0x100000f60ï¼ˆ0x100000f60 &lt;+0&gt;: pushq  %rbpï¼‰ã€‚è¿™é‡Œ 0x100000f60 æ˜¯ lldbå¸®æˆ‘ä»¬è®¡ç®—å‡ºæ¥çš„å€¼ï¼Œç®—æ³•æ˜¯ï¼šç›®çš„å€¼ = åç§»å€¼+ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œè¿™ä¸ªé€»è¾‘å°±æ˜¯åœ°å€æ— å…³ä»£ç ï¼ˆposition independent codeï¼‰</p>

<p>ç„¶åæˆ‘ä»¬éªŒè¯ç¬¬ä¸€ç‚¹ï¼Œå…ˆçœ‹ä¸€ä¸‹å½“å‰å†…å­˜ä¸­æ ˆé¡¶é™„è¿‘ï¼ˆrsp = 0x00007ffeefbff330ï¼‰å­˜å‚¨çš„æ•°å€¼ï¼ˆmemory read æŒ‡ä»¤ï¼‰</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>memory read --size 4 --format x --count 16 0x00007ffeefbff310

0x7ffeefbff310: 0x00000000 0x00000000 0xefbff398 0x00007ffe
0x7ffeefbff320: 0xefbff380 0x00007ffe (0x00000000 0x00000001)
0x7ffeefbff330: 0x00000001 0x0000000e 0x00000000 0x00000000
0x7ffeefbff340: 0x00000000 0x00000000 0x00000000 0x00000000
(lldb) 
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ä¸Šé¢çš„(0x00000000 0x00000001)è¡¨ç¤º0x7ffeefbff328åœ°å€å­˜çš„ç°åœ¨å­˜çš„å€¼æ˜¯ 0000000100000000(å°ç«¯æ¨¡å¼)ï¼Œåé¢åœ¨ä¼šè¢«è¦†ç›–æˆå‡½æ•°è¿”å›åœ°å€ 0x100000e34ã€‚</p>

<p>ç„¶åæ‰§è¡Œ stepã€‚å†æ¬¡è§‚å¯Ÿå¯„å­˜å™¨å’Œå†…å­˜æ•°å€¼çš„å˜åŒ–ï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre>memory read --size 4 --format x --count 16 0x00007ffeefbff310
0x7ffeefbff310: 0x00000000 0x00000000 0xefbff398 0x00007ffe
0x7ffeefbff320: 0xefbff380 0x00007ffe (0x00000e34 0x00000001)
0x7ffeefbff330: 0x00000001 0x0000000e 0x00000000 0x00000000
0x7ffeefbff340: 0x00000000 0x00000000 0x00000000 0x00000000

(lldb) register read
General Purpose Registers:
       rax = 0x0000000100000e20  a.out`main
       rbx = 0x0000000000000000
       rcx = 0x00007ffeefbff5a8
       rdx = 0x00007ffeefbff3a8
       rdi = 0x0000000000000001
       rsi = 0x00007ffeefbff398
       rbp = 0x00007ffeefbff370
       rsp = 0x00007ffeefbff328
        r8 = 0x0000000000000000
        r9 = 0x0000000000000000
       r10 = 0x0000000000000000
       r11 = 0x0000000000000000
       r12 = 0x0000000000000000
       r13 = 0x0000000000000000
       r14 = 0x0000000000000000
       r15 = 0x0000000000000000
       rip = 0x0000000100000f60  a.out`empty
    rflags = 0x0000000000000206
        cs = 0x000000000000002b
        fs = 0x0000000000000000
        gs = 0x0000000000000000
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°æœ‰ä¸‰ä¸ªåœ°æ–¹å˜åŒ–äº†</p>
<ol>
  <li>0x7ffeefbff328 åœ°å€å†…å­˜çš„å€¼æœ‰(0x00000000 0x00000001)å˜æˆäº†(0x00000e34 0x00000001ï¼Œå³å°ç«¯æ¨¡å¼ä¸‹çš„ 0000000100000e34)ï¼Œæ­£å¥½æ˜¯ callq  0x100000f60 çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ 0x100000e34ã€‚</li>
  <li>å› ä¸ºæœ‰æ–°çš„å€¼å…¥æ ˆäº†ï¼Œæ‰€ä»¥rspçš„å€¼ä¹Ÿéœ€è¦æ›´æ–°åˆ°æ–°çš„æ ˆé¡¶ï¼Œå³ 0x00007ffeefbff330 - 8 = 0x00007ffeefbff328ï¼ˆpushå…¥æ ˆçš„æŒ‡é’ˆå 8ä¸ªå­—èŠ‚ï¼‰</li>
  <li>ripæŒ‡å‘äº†æ–°çš„æŒ‡ä»¤åœ°å€ï¼šemptyå‡½æ•°çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ï¼šrip = 0x0000000100000f60  a.out`empty</li>
</ol>

<p>æ‰§è¡Œå®ŒcallæŒ‡ä»¤åï¼Œæ‰§è¡Œé€»è¾‘å°±ä»mainè·³å‡ºæ¥ï¼Œå»æ‰§è¡Œemptyäº†ã€‚</p>

<center><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gfufv8slmmj31dg0u0jsc.jpg" width="800" /></center>

<h4 id="pushq---rbp--movq--rsp-rbp">pushq   %rbp &amp; movq  %rsp, %rbp</h4>

<p>æ‰€æœ‰å‡½æ•°çš„å¼€å¤´éƒ½éœ€è¦æ‰§è¡Œè¿™ä¸¤è¡Œå‡½æ•°ï¼Œå®ƒçš„ç›®çš„æ˜¯æš‚å­˜ä¸Šä¸€ä¸ªå‡½æ•°çš„rbpæŒ‡é’ˆï¼Œå¹¶æŠŠrbpæŒ‡é’ˆæ›´æ–°æŒ‡å‘åˆ°æ–°çš„æ ˆå¸§</p>
<ol>
  <li>pushq %rbpï¼šæš‚å­˜ä¸€ä¸ªå‡½æ•°çš„rbpæŒ‡é’ˆ</li>
  <li>movq  %rsp, %rbpï¼šrbpæŒ‡é’ˆæ›´æ–°æŒ‡å‘åˆ°æ–°çš„æ ˆå¸§</li>
</ol>

<p>ç¬¬ä¸€æ­¥ï¼šéªŒè¯ä¸€ä¸‹ pushq  %rbpï¼Œé¦–å…ˆçœ‹ä¸‹å½“å‰å¯„å­˜å™¨å’Œå†…å­˜çš„çŠ¶æ€ï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre>(lldb) memory read --size 4 --format x --count 16 0x00007ffeefbff310
0x7ffeefbff310: 0x00000000 0x00000000 0xefbff398 0x00007ffe
0x7ffeefbff320: (0xefbff380 0x00007ffe) 0x00000e34 0x00000001
0x7ffeefbff330: 0x00000001 0x0000000e 0x00000000 0x00000000
0x7ffeefbff340: 0x00000000 0x00000000 0x00000000 0x00000000
(lldb) register read
General Purpose Registers:
       rax = 0x0000000100000e20  a.out`main
       rbx = 0x0000000000000000
       rcx = 0x00007ffeefbff5a8
       rdx = 0x00007ffeefbff3a8
       rdi = 0x0000000000000001
       rsi = 0x00007ffeefbff398
       rbp = 0x00007ffeefbff370
       rsp = 0x00007ffeefbff328
        r8 = 0x0000000000000000
        r9 = 0x0000000000000000
       r10 = 0x0000000000000000
       r11 = 0x0000000000000000
       r12 = 0x0000000000000000
       r13 = 0x0000000000000000
       r14 = 0x0000000000000000
       r15 = 0x0000000000000000
       rip = 0x0000000100000f60  a.out`empty
    rflags = 0x0000000000000206
        cs = 0x000000000000002b
        fs = 0x0000000000000000
        gs = 0x0000000000000000
</pre></td></tr></tbody></table></code></pre></div></div>
<p>å…¶ä¸­ 0x7ffeefbff320 åœ°å€ä¸­çš„å€¼ï¼ˆ0x00000001 0x0000000eï¼‰ä¸€ä¼šå„¿æ˜¯è¦è¢«å½“å‰ rbp çš„å€¼ï¼ˆrbp = 0x00007ffeefbff370ï¼‰è¦†ç›–çš„ï¼Œç„¶å rsp ä¼šå‡â€œ1â€ï¼Œå˜æˆ 0x00007ffeefbff320ã€‚okï¼Œæˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹ stepï¼Œçœ‹ä¸‹ç»“æœï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre>(lldb) memory read --size 4 --format x --count 16 0x00007ffeefbff310
0x7ffeefbff310: 0x00000000 0x00000000 0xefbff398 0x00007ffe
0x7ffeefbff320: (0xefbff370 0x00007ffe) 0x00000e34 0x00000001
0x7ffeefbff330: 0x00000001 0x0000000e 0x00000000 0x00000000
0x7ffeefbff340: 0x00000000 0x00000000 0x00000000 0x00000000
(lldb) register read
General Purpose Registers:
       rax = 0x0000000100000e20  a.out`main
       rbx = 0x0000000000000000
       rcx = 0x00007ffeefbff5a8
       rdx = 0x00007ffeefbff3a8
       rdi = 0x0000000000000001
       rsi = 0x00007ffeefbff398
       rbp = 0x00007ffeefbff370
       rsp = 0x00007ffeefbff320
        r8 = 0x0000000000000000
        r9 = 0x0000000000000000
       r10 = 0x0000000000000000
       r11 = 0x0000000000000000
       r12 = 0x0000000000000000
       r13 = 0x0000000000000000
       r14 = 0x0000000000000000
       r15 = 0x0000000000000000
       rip = 0x0000000100000f61  a.out`empty + 1
    rflags = 0x0000000000000206
        cs = 0x000000000000002b
        fs = 0x0000000000000000
        gs = 0x0000000000000000
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ç»“æœå’Œé¢„æ–™çš„ä¸€æ ·ï¼Œç°åœ¨ï¼šrsp = 0x00007ffeefbff320ï¼Œåœ°å€ 0x7ffeefbff320 å­˜å‚¨çš„å€¼æ˜¯ 0x00007ffeefbff370ï¼ˆå°ç«¯æ¨¡å¼ï¼‰ã€‚</p>

<center><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gfv1ltg2exj31cz0u075c.jpg" width="800" /></center>

<p>ç¬¬äºŒæ­¥ï¼šmovq  %rsp, %rbpï¼Œæ˜¯æŠŠ rsp çš„å€¼èµ‹å€¼ç»™ rbpï¼Œè¿™æ · rbp å°±æŒ‡å‘äº†æ–°çš„æ ˆå¸§çš„æ ˆåº•ï¼Œä»£è¡¨å¼€è¾Ÿäº†äº†ä¸€ä¸ªæ–°çš„æ ˆå¸§ï¼Œå³ empty å‡½æ•°çš„æ ˆå¸§ã€‚æ‰§è¡Œ step ï¼Œçœ‹ä¸‹ç»“æœï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre>General Purpose Registers:
       rax = 0x0000000100000e20  a.out`main
       rbx = 0x0000000000000000
       rcx = 0x00007ffeefbff5a8
       rdx = 0x00007ffeefbff3a8
       rdi = 0x0000000000000001
       rsi = 0x00007ffeefbff398
       rbp = 0x00007ffeefbff320 // rbpçš„å€¼æ›´æ–°äº†ï¼Œç›®å‰å’Œ rsp ç›¸åŒ
       rsp = 0x00007ffeefbff320
        r8 = 0x0000000000000000
        r9 = 0x0000000000000000
       r10 = 0x0000000000000000
       r11 = 0x0000000000000000
       r12 = 0x0000000000000000
       r13 = 0x0000000000000000
       r14 = 0x0000000000000000
       r15 = 0x0000000000000000
       rip = 0x0000000100000f64  a.out`empty + 4
    rflags = 0x0000000000000206
        cs = 0x000000000000002b
        fs = 0x0000000000000000
        gs = 0x0000000000000000
</pre></td></tr></tbody></table></code></pre></div></div>

<center><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gfv1sgy0i1j31dv0u0gmu.jpg" width="800" /></center>

<p>ä»¥ä¸Šå°±æ˜¯ä¸€ä¸ªç©ºå‡½æ•°è°ƒç”¨æ—¶ï¼ŒCPUè·³è½¬æ–°å‡½æ•°å’Œæ–°æ ˆå¸§å¼€è¾Ÿçš„é€»è¾‘ã€‚å› ä¸º empty å‡½æ•°ä¸­æ²¡æœ‰ä»»ä½•å®ç°ï¼Œæ‰€ä»¥æ¥ç€ä¼šé©¬ä¸Šè¿”å›ã€‚</p>

<h4 id="popq---rbp--retq">popq   %rbp &amp; retq</h4>

<p>æ‰€æœ‰å‡½æ•°çš„æ±‡ç¼–æŒ‡ä»¤ä¹Ÿéƒ½æ˜¯æœ‰è¿™ä¸¤æ¡æŒ‡ä»¤ä½œä¸ºç»“å°¾ï¼Œè¿™ä¸¤æ¡æŒ‡ä»¤çš„å«ä¹‰æ˜¯ï¼šå–å›æš‚å­˜çš„ rbp æŒ‡é’ˆå¹¶æ¢å¤ rbp å¯„å­˜å™¨çš„å€¼ï¼Œç„¶åå–å‡ºæš‚å­˜çš„è¿”å›æŒ‡ä»¤çš„åœ°å€ï¼Œå¹¶è·³è½¬æ‰§è¡Œã€‚</p>
<ol>
  <li>popq   %rbpï¼š å–å›æš‚å­˜çš„ rbp æŒ‡é’ˆå¹¶æ¢å¤ rbp å¯„å­˜å™¨çš„å€¼ã€‚</li>
  <li>å–å‡ºæš‚å­˜çš„è¿”å›æŒ‡ä»¤çš„åœ°å€ï¼Œå¹¶è·³è½¬æ‰§è¡Œã€‚</li>
</ol>

<p>ç¬¬ä¸€æ­¥éªŒè¯ï¼špopq   %rbpã€‚çœ‹ä¸‹æ‰§è¡Œè¿™ä¸€æ­¥ä¹‹å‰ï¼Œå¯„å­˜å™¨å’Œå†…å­˜çš„çŠ¶æ€ï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre>(lldb) register read
General Purpose Registers:
       rax = 0x0000000100000e20  a.out`main
       rbx = 0x0000000000000000
       rcx = 0x00007ffeefbff5a8
       rdx = 0x00007ffeefbff3a8
       rdi = 0x0000000000000001
       rsi = 0x00007ffeefbff398
       rbp = 0x00007ffeefbff320
       rsp = 0x00007ffeefbff320
        r8 = 0x0000000000000000
        r9 = 0x0000000000000000
       r10 = 0x0000000000000000
       r11 = 0x0000000000000000
       r12 = 0x0000000000000000
       r13 = 0x0000000000000000
       r14 = 0x0000000000000000
       r15 = 0x0000000000000000
       rip = 0x0000000100000f64  a.out`empty + 4
    rflags = 0x0000000000000206
        cs = 0x000000000000002b
        fs = 0x0000000000000000
        gs = 0x0000000000000000

(lldb) memory read --size 4 --format x --count 16 0x00007ffeefbff310
0x7ffeefbff310: 0x00000000 0x00000000 0xefbff398 0x00007ffe
0x7ffeefbff320: 0xefbff370 0x00007ffe 0x00000e34 0x00000001
0x7ffeefbff330: 0x00000001 0x0000000e 0x00000000 0x00000000
0x7ffeefbff340: 0x00000000 0x00000000 0x00000000 0x00000000
</pre></td></tr></tbody></table></code></pre></div></div>
<p>å½“å‰æ ˆé¡¶åœ°å€æ˜¯ï¼šrsp = 0x00007ffeefbff320ï¼Œæ ˆé¡¶åœ°å€å­˜å‚¨çš„å€¼æ˜¯ï¼š0xefbff370 0x00007ffeï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¹‹å‰æš‚å­˜çš„ä¸Šä¸€ä¸ªå‡½æ•°çš„æ ˆå¸§çš„åŸºåœ°å€ã€‚ç„¶åæ‰§è¡Œ stepï¼Œçœ‹ä¸‹ç»“æœï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre>(lldb) register read 
General Purpose Registers:
       rax = 0x0000000100000e20  a.out`main
       rbx = 0x0000000000000000
       rcx = 0x00007ffeefbff5a8
       rdx = 0x00007ffeefbff3a8
       rdi = 0x0000000000000001
       rsi = 0x00007ffeefbff398
       rbp = 0x00007ffeefbff370
       rsp = 0x00007ffeefbff328
        r8 = 0x0000000000000000
        r9 = 0x0000000000000000
       r10 = 0x0000000000000000
       r11 = 0x0000000000000000
       r12 = 0x0000000000000000
       r13 = 0x0000000000000000
       r14 = 0x0000000000000000
       r15 = 0x0000000000000000
       rip = 0x0000000100000f65  a.out`empty + 5
    rflags = 0x0000000000000206
        cs = 0x000000000000002b
        fs = 0x0000000000000000
        gs = 0x0000000000000000
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ç°åœ¨ rbp = 0x00007ffeefbff370ï¼Œrbp å¯„å­˜å™¨æ¢å¤äº†ï¼ŒåŒæ—¶ rsp å¢åŠ äº† â€œ1â€ï¼ˆå› ä¸ºæ‰§è¡Œäº† pop æŒ‡ä»¤ï¼Œæ ˆçš„é•¿åº¦å‡å°‘äº†ï¼‰ï¼Œæ­¤æ—¶ï¼š</p>

<center><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gfv27e3rp6j31dd0u0myf.jpg" width="800" /></center>

<p>ç¬¬äºŒæ­¥æ‰§è¡Œï¼šretqï¼Œè¿™ä¸€æ­¥ä¼šå–å‡ºå½“å‰æ ˆé¡¶çš„å€¼ï¼Œå³æš‚å­˜çš„éœ€è¦è¿”å›åˆ°çš„æŒ‡ä»¤çš„åœ°å€ï¼ˆæ­¤æ—¶æ˜¯ 0x100000e34ï¼‰ã€‚å…ˆçœ‹ä¸€ä¸‹å½“å‰çŠ¶æ€ï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre>(lldb) memory read --size 4 --format x --count 16 0x00007ffeefbff310
0x7ffeefbff310: 0x00000000 0x00000000 0xefbff398 0x00007ffe
0x7ffeefbff320: 0xefbff370 0x00007ffe (0x00000e34 0x00000001)
0x7ffeefbff330: 0x00000001 0x0000000e 0x00000000 0x00000000
0x7ffeefbff340: 0x00000000 0x00000000 0x00000000 0x00000000
(lldb) register read
General Purpose Registers:
       rax = 0x0000000100000e20  a.out`main
       rbx = 0x0000000000000000
       rcx = 0x00007ffeefbff5a8
       rdx = 0x00007ffeefbff3a8
       rdi = 0x0000000000000001
       rsi = 0x00007ffeefbff398
       rbp = 0x00007ffeefbff370
       rsp = 0x00007ffeefbff328
        r8 = 0x0000000000000000
        r9 = 0x0000000000000000
       r10 = 0x0000000000000000
       r11 = 0x0000000000000000
       r12 = 0x0000000000000000
       r13 = 0x0000000000000000
       r14 = 0x0000000000000000
       r15 = 0x0000000000000000
       rip = 0x0000000100000f65  a.out`empty + 5
    rflags = 0x0000000000000206
        cs = 0x000000000000002b
        fs = 0x0000000000000000
        gs = 0x0000000000000000
</pre></td></tr></tbody></table></code></pre></div></div>
<p>rsp = 0x00007ffeefbff328ï¼Œrsp æ‰§è¡Œå½“å‰æ ˆé¡¶ï¼Œå½“å‰æ ˆé¡¶å­˜å‚¨çš„å€¼æ˜¯ (0x00000e34 0x00000001)ã€‚ç„¶åæ‰§è¡Œ stepï¼Œ çœ‹ä¸‹ç»“æœï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre>(lldb) disassemble 
a.out`empty:
    0x100000f60 &lt;+0&gt;: pushq  %rbp
    0x100000f61 &lt;+1&gt;: movq   %rsp, %rbp
    0x100000f64 &lt;+4&gt;: popq   %rbp
-&gt;  0x100000f65 &lt;+5&gt;: retq   
(lldb) step
Process 45685 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = instruction step into
    frame #0: 0x0000000100000e34 a.out`main + 20
a.out`main:
-&gt;  0x100000e34 &lt;+20&gt;: movl   $0x3, -0x8(%rbp)
    0x100000e3b &lt;+27&gt;: movl   $0x4, -0xc(%rbp)
    0x100000e42 &lt;+34&gt;: movl   -0x8(%rbp), %edi
    0x100000e45 &lt;+37&gt;: movl   -0xc(%rbp), %esi
Target 0: (a.out) stopped.
(lldb) register read 
General Purpose Registers:
       rax = 0x0000000100000e20  a.out`main
       rbx = 0x0000000000000000
       rcx = 0x00007ffeefbff5a8
       rdx = 0x00007ffeefbff3a8
       rdi = 0x0000000000000001
       rsi = 0x00007ffeefbff398
       rbp = 0x00007ffeefbff370
       rsp = 0x00007ffeefbff330
        r8 = 0x0000000000000000
        r9 = 0x0000000000000000
       r10 = 0x0000000000000000
       r11 = 0x0000000000000000
       r12 = 0x0000000000000000
       r13 = 0x0000000000000000
       r14 = 0x0000000000000000
       r15 = 0x0000000000000000
       rip = 0x0000000100000e34  a.out`main + 20
    rflags = 0x0000000000000206
        cs = 0x000000000000002b
        fs = 0x0000000000000000
        gs = 0x0000000000000000
</pre></td></tr></tbody></table></code></pre></div></div>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæ‰§è¡Œå®Œ retq åï¼ŒCPUæŒ‡å‘äº†éœ€è¦è¿”å›çš„æŒ‡ä»¤åœ°å€ï¼š0x100000e34ï¼ˆrip = 0x0000000100000e34ï¼‰ï¼›rsp ç»§ç»­åŠ â€œ1â€ã€‚æ­¤æ—¶ å‡½æ•°çš„æ ˆå¸§æ¢å¤äº†ä¹‹å‰åœ¨mainå‡½æ•°çš„çŠ¶æ€ï¼š</p>

<center><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gfv2exw2p0j31d70u0wfr.jpg" width="800" /></center>

<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œä¸€ä¸ªç©ºå‡½æ•°çš„è°ƒç”¨å’Œè¿”å›è¿‡ç¨‹å°±ç»“æŸäº†ï¼Œæˆ‘ä»¬å†æ¥æ€»ç»“ä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹ï¼š</p>

<h3 id="å‡½æ•°è°ƒç”¨è¿‡ç¨‹">å‡½æ•°è°ƒç”¨è¿‡ç¨‹</h3>

<center><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gfv3dqvw9uj31800u0gn0.jpg" width="800" /></center>

<h3 id="ä¼ å‚--è¿”å›å€¼">ä¼ å‚ &amp; è¿”å›å€¼</h3>

<p>å‡½æ•°è°ƒç”¨æ—¶ï¼Œæœ‰ä¸¤ç§ä¼ å‚æ–¹å¼ï¼š</p>
<ol>
  <li>å¯„å­˜å™¨å¤Ÿç”¨æ—¶ï¼Œæ˜¯å¯„å­˜å™¨ä¼ å‚</li>
  <li>å¯„å­˜å™¨ä¸å¤Ÿç”¨æ—¶ï¼ŒæŠŠå‚æ•° push åˆ°æ ˆä¸Šï¼Œç”¨æ ˆå†…å­˜ä¼ å‚ã€‚</li>
</ol>

<p>è¿”å›å€¼ï¼š</p>
<ol>
  <li>åˆ©ç”¨å¯„å­˜å™¨ eax å­˜å‚¨è¿”å›å€¼ï¼Œè¿”å›ç»™ä¸Šä¸€çº§å‡½æ•°ã€‚</li>
</ol>

<h4 id="å¯„å­˜å™¨ä¼ å‚">å¯„å­˜å™¨ä¼ å‚</h4>

<p>æˆ‘ä»¬ä»¥ add å‡½æ•°ä¸ºä¾‹åˆ†æï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>// æµ‹è¯•ä¼ 2ä¸ªå‚æ•°çš„å‡½æ•°
int i = 3;
int j = 4;
int k = add(i, j);

	int add(int i, int j)
{
	int k = i + j;
	return k;
}
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre>a.out`main:
-&gt;  0x100000e20 &lt;+0&gt;:   pushq  %rbp
    0x100000e21 &lt;+1&gt;:   movq   %rsp, %rbp
    0x100000e24 &lt;+4&gt;:   subq   $0x40, %rsp
    0x100000e28 &lt;+8&gt;:   movl   $0x0, -0x4(%rbp)
    0x100000e2f &lt;+15&gt;:  callq  0x100000f60
    0x100000e34 &lt;+20&gt;:  movl   $0x3, -0x8(%rbp)      
    0x100000e3b &lt;+27&gt;:  movl   $0x4, -0xc(%rbp)
    0x100000e42 &lt;+34&gt;:  movl   -0x8(%rbp), %edi      // å‚æ•°ï¼šæ•°å­— 3 æ”¾å…¥ edi ä¸­
    0x100000e45 &lt;+37&gt;:  movl   -0xc(%rbp), %esi      // å‚æ•°ï¼šæ•°å­— 4 æ”¾å…¥ esi ä¸­
    0x100000e48 &lt;+40&gt;:  callq  0x100000eb0           ; add
    ..........

a.out`add:
    0x100000eb0 &lt;+0&gt;:  pushq  %rbp
    0x100000eb1 &lt;+1&gt;:  movq   %rsp, %rbp
    0x100000eb4 &lt;+4&gt;:  movl   %edi, -0x4(%rbp)      // ä» edi ä¸­å–å‡ºå‚æ•° 3
    0x100000eb7 &lt;+7&gt;:  movl   %esi, -0x8(%rbp)      // ä» esi ä¸­å–å‡ºå‚æ•° 4
    0x100000eba &lt;+10&gt;: movl   -0x4(%rbp), %esi      
    0x100000ebd &lt;+13&gt;: addl   -0x8(%rbp), %esi      // è®¡ç®— 3 + 4
    0x100000ec0 &lt;+16&gt;: movl   %esi, -0xc(%rbp)
    0x100000ec3 &lt;+19&gt;: movl   -0xc(%rbp), %eax      // 3 + 4 çš„ç»“æœæ”¾å…¥ eax ä¸­ï¼Œä½œä¸ºè¿”å›å‚æ•°è¿”å›
    0x100000ec6 &lt;+22&gt;: popq   %rbp
    0x100000ec7 &lt;+23&gt;: retq   
    0x100000ec8 &lt;+24&gt;: nopl   (%rax,%rax)
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="æ ˆå†…å­˜ä¼ å‚">æ ˆå†…å­˜ä¼ å‚</h4>

<p>æˆ‘ä»¬ä»¥ testParams å‡½æ•°ä¸ºä¾‹åˆ†æï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>// æµ‹è¯•ä¼ å¤šä¸ªå‚æ•°çš„å‡½æ•°
testParams(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11);

void testParams(int a, int b, int c, int d, int e, int f, int g, int h, int i, int j, int k)
{
	return;
}
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre>a.out`main:
    ........
    0x100000e50 &lt;+48&gt;:  movl   $0x1, %edi        // æ•°å­—1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ5ï¼Œ6 åˆ†åˆ«æ”¾å…¥äº† 6 ä¸ªå¯„å­˜å™¨
    0x100000e55 &lt;+53&gt;:  movl   $0x2, %esi
    0x100000e5a &lt;+58&gt;:  movl   $0x3, %edx
    0x100000e5f &lt;+63&gt;:  movl   $0x4, %ecx
    0x100000e64 &lt;+68&gt;:  movl   $0x5, %r8d
    0x100000e6a &lt;+74&gt;:  movl   $0x6, %r9d
    0x100000e70 &lt;+80&gt;:  movl   $0x7, (%rsp)      // æ•°å­—7ï¼Œ8ï¼Œ9ï¼Œ10ï¼Œ11 åˆ†åˆ«æ”¾å…¥æ ˆå†…å­˜ï¼ˆmainçš„æ ˆå¸§ç©ºé—´ï¼‰
    0x100000e77 &lt;+87&gt;:  movl   $0x8, 0x8(%rsp)
    0x100000e7f &lt;+95&gt;:  movl   $0x9, 0x10(%rsp)
    0x100000e87 &lt;+103&gt;: movl   $0xa, 0x18(%rsp)
    0x100000e8f &lt;+111&gt;: movl   $0xb, 0x20(%rsp)
    0x100000e97 &lt;+119&gt;: callq  0x100000ed0               ; testParams
    ........

a.out`testParams:
    0x100000ed0 &lt;+0&gt;:  pushq  %rbp
    0x100000ed1 &lt;+1&gt;:  movq   %rsp, %rbp
    0x100000ed4 &lt;+4&gt;:  pushq  %r14
    0x100000ed6 &lt;+6&gt;:  pushq  %rbx
    0x100000ed7 &lt;+7&gt;:  movl   0x30(%rbp), %eax   // ä»æ ˆå†…å­˜ä¸­æŠŠå‚æ•°è¯»å–å‡ºæ¥ï¼Œå¹¶æ”¾å…¥testParamsçš„æ ˆå¸§ç©ºé—´
    0x100000eda &lt;+10&gt;: movl   0x28(%rbp), %r10d
    0x100000ede &lt;+14&gt;: movl   0x20(%rbp), %r11d
    0x100000ee2 &lt;+18&gt;: movl   0x18(%rbp), %ebx
    0x100000ee5 &lt;+21&gt;: movl   0x10(%rbp), %r14d
    0x100000ee9 &lt;+25&gt;: movl   %edi, -0x14(%rbp)
    0x100000eec &lt;+28&gt;: movl   %esi, -0x18(%rbp)
    0x100000eef &lt;+31&gt;: movl   %edx, -0x1c(%rbp)
    0x100000ef2 &lt;+34&gt;: movl   %ecx, -0x20(%rbp)
    0x100000ef5 &lt;+37&gt;: movl   %r8d, -0x24(%rbp)
    0x100000ef9 &lt;+41&gt;: movl   %r9d, -0x28(%rbp)
    0x100000efd &lt;+45&gt;: movl   %eax, -0x2c(%rbp)
    0x100000f00 &lt;+48&gt;: movl   %r10d, -0x30(%rbp)
    0x100000f04 &lt;+52&gt;: movl   %r11d, -0x34(%rbp)
    0x100000f08 &lt;+56&gt;: movl   %ebx, -0x38(%rbp)
    0x100000f0b &lt;+59&gt;: movl   %r14d, -0x3c(%rbp)
    0x100000f0f &lt;+63&gt;: popq   %rbx
    0x100000f10 &lt;+64&gt;: popq   %r14
    0x100000f12 &lt;+66&gt;: popq   %rbp
    0x100000f13 &lt;+67&gt;: retq   
    0x100000f14 &lt;+68&gt;: nopw   %cs:(%rax,%rax)
    0x100000f1e &lt;+78&gt;: nop    
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="ä¸å®šå‚æ•°ä¼ å‚">ä¸å®šå‚æ•°ä¼ å‚</h4>

:ET