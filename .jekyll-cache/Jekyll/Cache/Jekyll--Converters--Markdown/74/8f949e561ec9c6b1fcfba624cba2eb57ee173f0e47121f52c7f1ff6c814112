I"ä<p>æœ¬ç¯‡å®ç°Jackçš„ç¼–è¯‘å™¨ï¼Œä¹Ÿæ˜¯ä»0åˆ°1æ„å»ºè®¡ç®—æœºç³»åˆ—æœ€å¤æ‚çš„ä¸€ç¯‡ã€‚ç¼–è¯‘å™¨çš„å®ç°æœ¬èº«æ˜¯éå¸¸å¤æ‚çš„ï¼Œä½†å¾—ç›ŠäºJackè¶…ç®€æ´çš„è¯­æ³•ï¼Œæˆ‘ä»¬å›é¿æ‰äº†å¾ˆå¤šå¤æ‚çš„é—®é¢˜ã€‚æ€»ä½“ä¸ŠJackç¼–è¯‘å™¨æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç¼–è¯‘å™¨ï¼Œå®ƒåŒ…æ‹¬è¯æ³•åˆ†æï¼Œè¯­æ³•åˆ†æï¼Œè¯­ä¹‰åˆ†æï¼Œä»£ç ç”Ÿæˆç­‰é‡è¦ä¸»é¢˜ã€‚</p>

<p>é«˜çº§è¯­è¨€ä¸ºä»€ä¹ˆèƒ½å¤Ÿè¢«ç¼–è¯‘å™¨ç†è§£å’Œç¼–è¯‘ï¼Ÿå› ä¸ºé«˜çº§è¯­è¨€æ˜¯æŒ‰ç…§æŸç§è§„åˆ™çš„è¯­æ³•ï¼ˆä¸Šä¸‹æ–‡æ— å…³è¯­æ³•ï¼‰ç»„ç»‡çš„ï¼Œç»“æ„ä¸Šå±‚æ¬¡åŒ–çš„è¯­è¨€ã€‚ç¨‹åºçš„æ¯ä¸ªç±»ï¼Œæ¯æ¡è¯­å¥éƒ½æ˜¯ç¬¦åˆæŸç§è¯­æ³•è§„åˆ™çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åè¿‡æ¥èƒ½å¤Ÿä½¿ç”¨è¿™äº›è¯­æ³•è§„åˆ™å¯¹å…¶è¿›è¡Œå‡†ç¡®åœ°è§£æï¼Œè€Œæˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨çš„è‡ªç„¶è¯­è¨€åˆ™ä¸å¤ªå—è¯­æ³•çš„ä¸¥æ ¼çš„çº¦æŸï¼Œæ‰€ä»¥ç”¨ç®—æ³•è§£é‡Šè‡ªç„¶è¯­è¨€ä¼šæ›´å›°éš¾ã€‚</p>

<h3 id="è¯æ³•åˆ†æ">è¯æ³•åˆ†æ</h3>

<p>ç¨‹åºåŸºæœ¬ä¸Šç”±è¯­å¥ç»„æˆï¼Œè¯­å¥ç”±å•è¯å’Œç¬¦å·ç»„æˆï¼Œæ¯ä¸ªå•è¯æˆ–ç¬¦å·éƒ½æœ‰å®ƒè¦è¡¨è¾¾çš„å«ä¹‰ï¼šæˆ–æ˜¯æŸç§é¢„ç®—æ“ä½œï¼Œæˆ–æ˜¯æŸå—å†…å­˜çš„æŒ‡é’ˆï¼Œæˆ–æ˜¯æŒ‡æ˜å½“å‰è¯­å¥æ˜¯é‚£ç§ç±»å‹ç­‰ç­‰ã€‚ç¼–è¯‘å™¨è¦åšçš„ç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯æŠŠè¯­å¥æ‹†è§£æˆä¸€ä¸ªä¸ªå•è¯æˆ–ç¬¦å·ï¼Œå³è¯æ³•åˆ†æã€‚</p>
<center><img src="https://tva1.sinaimg.cn/large/0082zybply1gc9yj7rudwj314q0h4q3a.jpg" width="600" /></center>

<p>Jackè¯­æ³•ç”±ä¸€ä¸‹äº”ç±»å•è¯æ„æˆï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>1. å…³é”®å­—ï¼šå¤šç”¨äºæŒ‡æ˜å½“å‰è¯­å¥çš„ç±»å‹ã€å±æ€§ã€‚
2. ç¬¦å·ï¼šç®—æ•°é€»è¾‘è¿ç®—ç¬¦å·ã€åŠŸèƒ½ç¬¦å·ç­‰ã€‚
3. æ•´å‹æ•°å­—ï¼š0...32767
4. å­—ç¬¦åˆ›ï¼šâ€œâ€æ‹¬èµ·æ¥çš„å­—ç¬¦ä¸²ã€‚
5. å­—é¢é‡ï¼šç±»åã€å˜é‡åç­‰ã€‚
</pre></td></tr></tbody></table></code></pre></div></div>
<center><img src="https://tva1.sinaimg.cn/large/0082zybply1gc9yj6vuonj319g0m0abl.jpg" width="800" /></center>

<p>ä¸‹é¢ä»¥ä¸€ä¸ªç¨‹åºä¸¾ä¾‹ï¼š</p>
<center><img src="https://tva1.sinaimg.cn/large/0082zybply1gca095p9hmj31cg0ne0vp.jpg" width="800" /></center>

<h4 id="å®ç°">å®ç°</h4>

<p>è¯æ³•åˆ†æçš„è¿‡ç¨‹å¹¶ä¸å¤æ‚ã€‚å…ˆåˆ é™¤è¾“å…¥ç¨‹åºä¸­çš„æ³¨é‡Šä»£ç ï¼Œç„¶åé€šè¿‡ä½¿ç”¨Rubyçš„StringScannerå·¥å…·å’Œä¸€äº›æ­£åˆ™æ“ä½œæŠŠæºç¨‹åºæ‹†è§£æˆä»¥ä¸Šäº”ç§ç±»å‹çš„å•è¯å³å¯ã€‚æˆ‘ä»¬ç”¨JackTokenizeræ¥å®ç°Jackçš„è¯æ³•åˆ†æï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>JackTokenizeræ¥å£è®¾è®¡ï¼š

constructorï¼šè¾“å…¥æºç¨‹åºï¼Œå®Œæˆè¯æ³•åˆ†æ
hasMoreTokenï¼šæ˜¯å¦è¿˜æ˜¯token
advanceï¼štokenæ¸¸æ ‡å‰è¿›ä¸€ä½
tokenTypeï¼šå½“å‰tokenç±»å‹
keywordï¼šè¿”å›å½“å‰å…³é”®å­—ç±»å‹çš„token
symbolï¼šè¿”å›å½“å‰symbolç±»å‹çš„token
intValueï¼šè¿”å›å½“å‰intç±»å‹çš„token
stringValueï¼šè¿”å›å½“å‰stringç±»å‹çš„token
indentifierï¼šè¿”å›å½“å‰indentifierç±»å‹çš„token
</pre></td></tr></tbody></table></code></pre></div></div>
<p>è¯æ³•åˆ†æå…³é”®ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
</pre></td><td class="rouge-code"><pre><span class="vg">$KEYWORDS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"class"</span><span class="p">,</span> <span class="s2">"method"</span><span class="p">,</span> <span class="s2">"function"</span><span class="p">,</span> <span class="s2">"constructor"</span><span class="p">,</span> <span class="s2">"int"</span><span class="p">,</span> <span class="s2">"boolean"</span><span class="p">,</span> <span class="s2">"char"</span><span class="p">,</span> <span class="s2">"void"</span><span class="p">,</span> <span class="s2">"var"</span><span class="p">,</span> <span class="s2">"static"</span><span class="p">,</span> <span class="s2">"field"</span><span class="p">,</span> <span class="s2">"let"</span><span class="p">,</span> <span class="s2">"do"</span><span class="p">,</span> <span class="s2">"if"</span><span class="p">,</span> <span class="s2">"else"</span><span class="p">,</span> <span class="s2">"while"</span><span class="p">,</span> <span class="s2">"return"</span><span class="p">,</span> <span class="s2">"true"</span><span class="p">,</span> <span class="s2">"false"</span><span class="p">,</span> <span class="s2">"null"</span><span class="p">,</span> <span class="s2">"this"</span><span class="p">]</span>
<span class="vg">$SYMBOL</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"{"</span><span class="p">,</span> <span class="s2">"}"</span><span class="p">,</span> <span class="s2">"("</span><span class="p">,</span> <span class="s2">")"</span><span class="p">,</span> <span class="s2">"["</span><span class="p">,</span> <span class="s2">"]"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">","</span><span class="p">,</span> <span class="s2">";"</span><span class="p">,</span> <span class="s2">"+"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"*"</span><span class="p">,</span> <span class="s2">"/"</span><span class="p">,</span> <span class="s2">"&amp;"</span><span class="p">,</span> <span class="s2">"|"</span><span class="p">,</span> <span class="s2">"&lt;"</span><span class="p">,</span> <span class="s2">"&gt;"</span><span class="p">,</span> <span class="s2">"="</span><span class="p">,</span> <span class="s2">"~"</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">JackTokenizer</span>

<span class="k">def</span> <span class="nf">analysizeFile</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
  <span class="c1">#åˆ é™¤æ‰€æœ‰æ³¨é‡Š</span>
  <span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="sr">/((?:\/\*(?:[^*]|(?:\*+[^*\/]))*\*+\/)|(?:\/\/.*))/</span><span class="p">,</span> <span class="s1">''</span><span class="p">).</span><span class="nf">split</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">' '</span><span class="p">)</span>

  <span class="c1">#ä»£ç è½¬æˆtoken</span>
  <span class="vi">@tokens</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">scanTextToToken</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">writeTokensTofile</span><span class="p">(</span><span class="vi">@tokens</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">scanTextToToken</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
  <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">scanner</span> <span class="o">=</span> <span class="no">StringScanner</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
  <span class="k">while</span> <span class="o">!</span><span class="n">scanner</span><span class="p">.</span><span class="nf">eos?</span>
    <span class="c1"># æ‰«æå­—ç¬¦ä¸²ç±»å‹</span>
    <span class="n">stringToken</span> <span class="o">=</span> <span class="n">scanner</span><span class="p">.</span><span class="nf">scan</span><span class="p">(</span><span class="sr">/"[^"]*"/</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">stringToken</span>
      <span class="n">tokens</span> <span class="o">&lt;&lt;</span> <span class="n">stringToken</span>
      <span class="n">scanner</span><span class="p">.</span><span class="nf">scan</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">)</span>
      <span class="k">next</span>
    <span class="k">end</span>

    <span class="c1"># æ‰«æsymbol</span>
    <span class="n">symbolToken</span> <span class="o">=</span> <span class="n">scanner</span><span class="p">.</span><span class="nf">scan</span><span class="p">(</span><span class="sr">/\{|\}|\(|\)|\[|\]|\.|\,|\;|\+|\-|\*|\/|\&amp;|\||\&lt;|\&gt;|\=|\~/</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">symbolToken</span>
      <span class="n">tokens</span> <span class="o">&lt;&lt;</span> <span class="n">symbolToken</span>
      <span class="n">scanner</span><span class="p">.</span><span class="nf">scan</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">)</span>
      <span class="k">next</span>
    <span class="k">end</span>

    <span class="c1"># æ‰«æå…¶ä»–tokenotherToken</span>
    <span class="n">otherToken</span> <span class="o">=</span> <span class="n">scanner</span><span class="p">.</span><span class="nf">scan_until</span><span class="p">(</span><span class="sr">/\s+|\{|\}|\(|\)|\[|\]|\.|\,|\;|\+|\-|\*|\/|\&amp;|\||\&lt;|\&gt;|\=|\~/</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">otherToken</span>
      <span class="n">otherToken</span> <span class="o">=</span> <span class="n">otherToken</span><span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="n">otherToken</span><span class="p">.</span><span class="nf">length</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
      <span class="n">scanner</span><span class="p">.</span><span class="nf">pos</span> <span class="o">=</span> <span class="n">scanner</span><span class="p">.</span><span class="nf">pos</span><span class="o">-</span><span class="mi">1</span>
      <span class="n">tokens</span> <span class="o">&lt;&lt;</span> <span class="n">otherToken</span>
      <span class="n">scanner</span><span class="p">.</span><span class="nf">scan</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">)</span>
      <span class="k">next</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">return</span> <span class="n">tokens</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">writeTokensTofile</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
  <span class="vi">@tokenOutputFile</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"&lt;tokens&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
  <span class="n">tokens</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">token</span><span class="o">|</span>
    <span class="k">if</span> <span class="nb">self</span><span class="p">.</span><span class="nf">isKeyword</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
      <span class="vi">@tokenOutputFile</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"&lt;keyword&gt; </span><span class="si">#{</span><span class="n">token</span><span class="si">}</span><span class="s2"> &lt;/keyword&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">elsif</span> <span class="nb">self</span><span class="p">.</span><span class="nf">isString</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
      <span class="n">token</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="mi">1</span><span class="o">..</span><span class="n">token</span><span class="p">.</span><span class="nf">length</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
      <span class="vi">@tokenOutputFile</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"&lt;stringConstant&gt; </span><span class="si">#{</span><span class="n">token</span><span class="si">}</span><span class="s2"> &lt;/stringConstant&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">elsif</span> <span class="nb">self</span><span class="p">.</span><span class="nf">isSymbol</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
      <span class="n">token</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">convertSymbol</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
      <span class="vi">@tokenOutputFile</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"&lt;symbol&gt; </span><span class="si">#{</span><span class="n">token</span><span class="si">}</span><span class="s2"> &lt;/symbol&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">elsif</span> <span class="nb">self</span><span class="p">.</span><span class="nf">isNumber</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
      <span class="vi">@tokenOutputFile</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"&lt;integerConstant&gt; </span><span class="si">#{</span><span class="n">token</span><span class="si">}</span><span class="s2"> &lt;/integerConstant&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="vi">@tokenOutputFile</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"&lt;identifier&gt; </span><span class="si">#{</span><span class="n">token</span><span class="si">}</span><span class="s2"> &lt;/identifier&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="vi">@tokenOutputFile</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"&lt;/tokens&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
  <span class="vi">@tokenOutputFile</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">isKeyword</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
  <span class="k">return</span> <span class="vg">$KEYWORDS</span><span class="p">.</span><span class="nf">include?</span> <span class="n">token</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">isSymbol</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
  <span class="k">return</span> <span class="vg">$SYMBOL</span><span class="p">.</span><span class="nf">include?</span> <span class="n">token</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">isNumber</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">token</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/\d+/</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">isString</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">token</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/"[^"]*"/</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="è¯­æ³•åˆ†æ">è¯­æ³•åˆ†æ</h3>

<p>æˆ‘ä»¬çš„ç¼–è¯‘å™¨å¾ˆèªæ˜ï¼Œå·²ç»æŒæ¡äº†Jackçš„å•è¯ï¼Œæ¥ä¸‹æ¥è¯¥å­¦ä¹ è¯­æ³•äº†ã€‚è¯­æ³•åˆ†æçš„ä»»åŠ¡æ˜¯åˆ†ææºç¨‹åºç±»ã€æ–¹æ³•çš„ç»“æ„å’Œæ¯æ¡è¯­å¥çš„ç»„æˆï¼Œåˆ†æçš„ç»“æœä»¥æŠ½è±¡è¯­æ³•æ ‘çš„æ–¹å¼å‘ˆç°ï¼Œæœ‰çš„ç¼–è¯‘å™¨ä¼šæ˜¾ç¤ºåœ°æ„é€ å‡ºæŠ½è±¡è¯­æ³•æ ‘ï¼ˆç”¨äºè¿›ä¸€æ­¥ä»£ç ç”Ÿæˆå’Œé”™è¯¯æŠ¥å‘Šï¼‰ï¼Œæœ‰çš„ç¼–è¯‘å™¨åˆ™éšå¼åœ°æ„é€ æŠ½è±¡è¯­æ³•æ ‘ï¼Œå³å®æ—¶çš„ç”Ÿæˆä»£ç å’Œé”™è¯¯æŠ¥å‘Šï¼Œä¸å¿…åœ¨å†…å­˜ä¸­ç»´æŠ¤æ•´ä¸ªæ ‘çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬çš„ç¼–è¯‘å™¨å±äºåè€…ï¼ˆä½†æˆ‘ä»¬åœ¨å®ç°çš„è¿‡ç¨‹ä¸­ä»ä¼šç”Ÿæˆä¸€ä¸ªxmlæ ¼å¼çš„æŠ½è±¡è¯­æ³•æ ‘ï¼Œç”¨äºéªŒè¯æˆ‘ä»¬çš„è¯­æ³•åˆ†æç¨‹åºæ˜¯å¦æ­£ç¡®ï¼‰ã€‚</p>
<center><img src="https://tva1.sinaimg.cn/large/0082zybply1gcayvbwgqfj310k0u0q82.jpg" width="800" /></center>

<h4 id="ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•">ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•</h4>

<p>å‡ ä¹æ‰€æœ‰çš„ç¼–ç¨‹è¯­è¨€ï¼Œä»¥åŠå¤§å¤šæ•°ç”¨äºæè¿°å¤æ‚æ–‡ä»¶çš„å…¶ä»–å½¢å¼çš„è¯­è¨€ï¼Œéƒ½å¯ä»¥ä½¿ç”¨ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•æè¿°ã€‚<strong>ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•æ˜¯ä¸€ç»„é€’å½’å¼çš„ï¼Œæ ‘çŠ¶ç»“æ„çš„è¯­æ³•è§„åˆ™ï¼Œç”¨æ¥æŒ‡å®šè¯­æ³•ä¸­çš„è¯­æ³•å…ƒç´ å¦‚ä½•ç”±æ›´ç®€å•çš„å…ƒç´ ç»„æˆ</strong>ã€‚ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•ç”±ç»ˆç»“ç¬¦å’Œéç»ˆç»“ç¬¦ä¸¤ç§å…ƒç´ æ„æˆï¼Œä¾‹å¦‚é’ˆå¯¹è¯­å¥ï¼šwhile (count &lt;= 100) { count ++; â€¦}ã€‚whileã€(ã€countã€++ ç­‰ç¬¦å·éƒ½å±äºç»ˆç»“ç¬¦ï¼Œå› ä¸ºå®ƒä»¬å·²ç»æ— æ³•å†ç»§ç»­åˆ†å‰²ï¼Œæ˜¯ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•ä¸–ç•Œçš„åŸå­çº§å­˜åœ¨ï¼›åŒæ—¶ç»ˆç»“ç¬¦ä¹Ÿå¯ä»¥äº’ç›¸ç»„åˆæˆæ›´é«˜çº§çš„éç»ˆç»“ç¬¦ï¼Œä¾‹å¦‚ count &lt;= 100 ç»„æˆäº†ä¸€ä¸ªexpressionï¼Œcount ++; ç»„æˆäº†ä¸€ä¸ªstatementï¼Œå¤šä¸ªstatementåˆå¯ä»¥ç»„æˆstatementSequenceç­‰ï¼Œexpressionã€statementã€statementSequenceéƒ½å±äºéç»ˆç»“ç¬¦ï¼Œä»–ä»¬æ˜¯å¯ä»¥å†å‘ä¸‹åˆ†å‰²çš„ã€‚<strong>è¯­æ³•åˆ†æè¿‡ç¨‹å°±æ˜¯æ­ç¤ºç¨‹åºä¸­éç»ˆç»“ç¬¦ä¸éç»ˆç»“ç¬¦ï¼Œéç»ˆç»“ç¬¦ä¸ç»ˆç»“ç¬¦å…³ç³»çš„è¿‡ç¨‹</strong>ã€‚</p>
<center><img src="https://tva1.sinaimg.cn/large/0082zybply1gcazdzfktbj31ac0sgq4h.jpg" width="800" /></center>

<h4 id="jackéç»ˆç»“ç¬¦">Jackéç»ˆç»“ç¬¦</h4>

<p>Jackçš„ç»ˆç»“ç¬¦æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬ä¸»è¦æ¥äº†è§£ä¸€ä¸‹éç»ˆç»“ç¬¦ï¼ŒJackçš„éç»ˆç»“ç¬¦ä¸»è¦å¯ä»¥åˆ†ä¸º3ç±»ï¼šç¨‹åºç»“æ„ç±»ã€è¯­å¥ç±»ã€è¡¨è¾¾å¼ç±»ã€‚</p>

<p>ç¨‹åºç»“æ„ç±»çš„éç»ˆç»“ç¬¦ç”¨äºåˆ†æclassçš„ç»“æ„ï¼Œå˜é‡å£°æ˜çš„ç»“æ„ï¼Œå‡½æ•°å£°æ˜ã€å‡½æ•°å®ç°ç­‰çš„ç»“æ„ï¼š</p>
<ol>
  <li>å…ˆå£°æ˜ç±»åï¼Œç„¶åæ˜¯è‹¥å¹²å˜é‡å£°æ˜ï¼ˆclassVarDecï¼‰ï¼Œç„¶åæ˜¯è‹¥å¹²å‡½æ•°çš„å‡ ä¸ªï¼ˆsubroutineDecï¼‰ã€‚</li>
  <li>classVarDecç”±å˜é‡å±æ€§ã€å˜é‡ç±»å‹ã€å˜é‡åä¸‰ä¸ªç»ˆç»“ç¬¦æ„æˆ</li>
  <li>subroutineDecç”±3ç§å‡½æ•°å£°æ˜ï¼Œå‚æ•°åˆ—è¡¨ï¼Œå‡½æ•°ä½“å®ç°ï¼ˆsubroutineBodyï¼‰æ„æˆ</li>
  <li>å‡½æ•°ä½“å®ç°ç”±è‹¥å¹²å±€éƒ¨å˜é‡å£°æ˜å’Œè‹¥å¹²è¯­å¥æ„æˆ</li>
  <li>çœç•¥â€¦å‚è€ƒä¸‹å›¾</li>
</ol>

<p><img src="https://tva1.sinaimg.cn/large/0082zybply1gcb007o2u6j317k0n20us.jpg" width="700" /></p>

<p>è¯­å¥ç±»çš„éç»ˆç»“ç¬¦ç”¨äºåˆ†æè¯­å¥ï¼ŒåŒ…æ‹¬ï¼šif, while, let, do, return 5ä¸­è¯­å¥ã€‚
<img src="https://tva1.sinaimg.cn/large/0082zybply1gcb0068i3sj317g0fgab1.jpg" width="700" /></p>

<p>è¡¨è¾¾å¼ç±»çš„éç»ˆç»“ç¬¦ç”¨äºåˆ†æè¡¨è¾¾å¼ï¼Œè¡¨è¾¾å¼æ˜¯Jackä¸‰ç§éç»ˆç»“ç¬¦æœ€å¤æ‚çš„ä¸€ç§ã€‚ä¸€ä¸ªè¡¨è¾¾å¼å¯ä»¥æœ‰ä¸€ä¸ªé¡¹æˆ–å¤šä¸ªé¡¹æ„æˆï¼›æ¯ä¸ªé¡¹å¯èƒ½æ˜¯æ•°å­—ã€å­—ç¬¦ä¸²ã€å…³é”®å­—ã€å˜é‡ã€æ•°ç»„ã€æˆ–è€…æ˜¯å‡½æ•°è°ƒç”¨ï¼Œç”šè‡³æ˜¯ç”¨æ‹¬å·æ‹¬èµ·æ¥çš„å¦ä¸€ä¸ªè¡¨è¾¾å¼ã€‚
<img src="https://tva1.sinaimg.cn/large/0082zybply1gcb005e8vfj317a0gugmp.jpg" width="700" /></p>

<h4 id="é€’å½’ä¸‹é™ç®—æ³•">é€’å½’ä¸‹é™ç®—æ³•</h4>

<p>æœ‰å¾ˆå¤šç®—æ³•å¯ä»¥ç”¨æ¥æ„å»ºè¯­æ³•åˆ†ææ ‘ï¼Œé€’å½’ä¸‹é™ç®—æ³•æ˜¯æ¯”è¾ƒæ˜æ˜¾å’Œç®€å•çš„ä¸€ç§ã€‚é€’å½’ä¸‹é™ç®—æ³•è‡ªé¡¶å‘ä¸‹åœ°æ„å»ºæŠ½è±¡è¯­æ³•æ ‘ï¼Œç¢°åˆ°è¯­æ³•ä¸­çš„éç»ˆç»“ç¬¦æ—¶ï¼Œç”¨ç›¸åº”çš„è¯­æ³•åˆ†æå‡½æ•°å¯¹å…¶è¿›è¡Œå¤„ç†ã€‚ä¾‹å¦‚ä¸‹å›¾ä¸­ï¼Œå¤„ç†whileè¯­å¥æ—¶ï¼Œå…ˆè°ƒç”¨compileWhileStatementå‡½æ•°ï¼Œä»£è¡¨è¯­æ³•æ ‘ç”Ÿæˆäº†ä¸€ä¸ªwhileè¯­å¥èŠ‚ç‚¹ï¼Œç„¶åå¤„ç†whileè¯­å¥çš„å…·ä½“å®ç°ï¼Œç”±äºwhileä¸­åˆåŒ…å«äº†å…¶ä»–éç»ˆç»“ç¬¦ï¼Œæ‰€ä»¥éœ€è¦ç»§ç»­é€’å½’çš„è°ƒç”¨å…¶ä»–è¯­æ³•åˆ†æå‡½æ•°ï¼ŒçŸ¥é“éç»ˆç»“ç¬¦å…¨éƒ¨ç”±ç»ˆç»“ç¬¦ç»„æˆæ—¶returnã€‚</p>
<center><img src="https://tva1.sinaimg.cn/large/0082zybply1gcazzd2l1kj318p0u0780.jpg" width="800" /></center>

<h4 id="å®ç°-1">å®ç°</h4>

<p>è¯­æ³•åˆ†æç¨‹åºä»å·¦åˆ°å³çš„è¯»å–è¯æ³•åˆ†æå™¨çš„tokenè¾“å‡ºï¼Œé‡åˆ°éç»ˆç»“ç¬¦åˆ™å¯¹å…¶è¿›è¡Œå±•å¼€ï¼Œå¦‚æœè¯¥éç»ˆç»“ç¬¦ä»ç”±å…¶ä»–éç»ˆç»“ç¬¦æ„æˆï¼Œåˆ™æ·±åº¦ä¼˜å…ˆçš„é€’å½’å±•å¼€è¿™äº›éç»ˆç»“ç¬¦ï¼Œç›´è‡³éç»ˆç»“ç¬¦å…¨éƒ¨ç”±ç»ˆç»“ç¬¦æ„æˆä¸ºæ­¢ã€‚è¯­æ³•åˆ†æéƒ¨åˆ†å®Œæ•´çš„å®ç°è¾ƒé•¿ï¼Œè¿™é‡Œä»…ä¸¾å‡ ä¸ªéç»ˆç»“ç¬¦çš„è¯­æ³•åˆ†æè¿‡ç¨‹ã€‚</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">CompilationEngine</span>
  <span class="c1">#compile method</span>
  <span class="c1">#ç¼–è¯‘æ•´ä¸ªç±»</span>
  <span class="k">def</span> <span class="nf">compileClass</span>
    <span class="vi">@outputfile</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"&lt;class&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">writeKeyword</span><span class="p">()</span> <span class="c1">#class</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">writeIndentifier</span><span class="p">()</span> <span class="c1">#className</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">writeSymbol</span><span class="p">()</span> <span class="c1">#{</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">compileClassVarDec</span><span class="p">()</span> <span class="c1">#classVarDec*</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">compileSubroutine</span><span class="p">()</span> <span class="c1">#subroutine*</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">writeSymbol</span><span class="p">()</span> <span class="c1">#}</span>
    <span class="vi">@outputfile</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"&lt;/class&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1">#ç¼–è¯‘é™æ€å˜é‡æˆ–æˆå‘˜å˜é‡çš„å£°æ˜</span>
  <span class="k">def</span> <span class="nf">compileClassVarDec</span>
    <span class="n">isVar</span> <span class="o">=</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">tokenType</span> <span class="o">==</span> <span class="s2">"KEYWORD"</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">keyword</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"static"</span> <span class="o">||</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">keyword</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"field"</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">isVar</span>
      <span class="vi">@outputfile</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"&lt;classVarDec&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">writeKeyword</span><span class="p">()</span> <span class="c1">#(static|field)</span>
      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">writeType</span><span class="p">()</span>
      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">writeVar</span><span class="p">()</span> <span class="c1">#varName or varNames</span>
      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
      <span class="n">isVar</span> <span class="o">=</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">tokenType</span> <span class="o">==</span> <span class="s2">"KEYWORD"</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">keyword</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"static"</span> <span class="o">||</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">keyword</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"field"</span><span class="p">)</span>
      <span class="vi">@outputfile</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"&lt;/classVarDec&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="k">return</span>
  <span class="k">end</span>

  <span class="c1">#ç¼–è¯‘å±€éƒ¨å˜é‡</span>
  <span class="k">def</span> <span class="nf">compileVarDec</span>
  <span class="o">...</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">compileSubroutine</span>
    <span class="n">isSubroutine</span> <span class="o">=</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">tokenType</span> <span class="o">==</span> <span class="s2">"KEYWORD"</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">keyword</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"constructor"</span> <span class="o">||</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">keyword</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"function"</span> <span class="o">||</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">keyword</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"method"</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">isSubroutine</span>
      <span class="vi">@outputfile</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"&lt;subroutineDec&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">writeKeyword</span><span class="p">()</span> <span class="c1">#(method type)</span>
      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
      <span class="k">if</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">tokenType</span> <span class="o">==</span> <span class="s2">"KEYWORD"</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">keyword</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"int"</span> <span class="o">||</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">keyword</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"char"</span> <span class="o">||</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">keyword</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"boolean"</span> <span class="o">||</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">keyword</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"void"</span><span class="p">)</span>
        <span class="nb">self</span><span class="p">.</span><span class="nf">writeKeyword</span><span class="p">()</span> <span class="c1">#(basic type)</span>
      <span class="k">elsif</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">tokenType</span> <span class="o">==</span> <span class="s2">"IDENTIFIER"</span>
        <span class="nb">self</span><span class="p">.</span><span class="nf">writeIndentifier</span><span class="p">()</span> <span class="c1">#(class type)</span>
      <span class="k">end</span>
      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">writeIndentifier</span><span class="p">()</span> <span class="c1">#method name</span>
      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">writeSymbol</span><span class="p">()</span> <span class="c1">#(</span>
      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">compileParameterList</span><span class="p">()</span> <span class="c1">#parameterList</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">writeSymbol</span><span class="p">()</span> <span class="c1">#)</span>
      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">compileSubroutineBody</span><span class="p">()</span> <span class="c1">#subroutineBody</span>
      <span class="vi">@outputfile</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"&lt;/subroutineDec&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
      <span class="n">isSubroutine</span> <span class="o">=</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">tokenType</span> <span class="o">==</span> <span class="s2">"KEYWORD"</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">keyword</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"constructor"</span> <span class="o">||</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">keyword</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"function"</span> <span class="o">||</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">keyword</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"method"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">return</span>
  <span class="k">end</span>

  <span class="c1">#ç¼–è¯‘å‚æ•°åˆ—è¡¨</span>
  <span class="k">def</span> <span class="nf">compileParameterList</span><span class="p">()</span>
  <span class="o">...</span>
  <span class="k">end</span>

  <span class="c1">#ç¼–è¯‘å‡½æ•°ä½“</span>
  <span class="k">def</span> <span class="nf">compileSubroutineBody</span><span class="p">()</span>
  <span class="o">...</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">compileStatements</span>
  <span class="o">...</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">compileLet</span>
  <span class="o">...</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">compileIF</span>
  <span class="o">...</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">compileWhile</span>
  <span class="o">...</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">compileReturn</span>
    <span class="vi">@outputfile</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"&lt;returnStatement&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">writeKeyword</span><span class="p">()</span> <span class="c1">#return</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="k">if</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">symbol</span><span class="p">()</span> <span class="o">==</span> <span class="s2">";"</span> <span class="c1">#æ•°ç»„</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">writeSymbol</span><span class="p">()</span> <span class="c1">#;</span>
    <span class="k">else</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">compileExpression</span><span class="p">()</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">writeSymbol</span><span class="p">()</span> <span class="c1">#;</span>
    <span class="k">end</span>
    <span class="vi">@outputfile</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"&lt;/returnStatement&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">compileDo</span>
  <span class="o">...</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">compileSubroutineCall</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">writeIndentifier</span><span class="p">()</span> <span class="c1">#æ–¹æ³•åæˆ–ç±»å¯¹è±¡æˆ–å®ä¾‹å¯¹è±¡</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="k">if</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">symbol</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"("</span> <span class="c1">#è°ƒå†…éƒ¨æ–¹æ³•åˆ†æ”¯</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">writeSymbol</span><span class="p">()</span> <span class="c1">#(</span>
      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">compileExpressionList</span><span class="p">()</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">writeSymbol</span><span class="p">()</span> <span class="c1">#)</span>
      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">writeSymbol</span><span class="p">()</span> <span class="c1">#;</span>
    <span class="k">elsif</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">symbol</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"."</span> <span class="c1">#è°ƒå¤–éƒ¨æ–¹æ³•åˆ†æ”¯</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">writeSymbol</span><span class="p">()</span> <span class="c1">#.</span>
      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">writeIndentifier</span><span class="p">()</span> <span class="c1">#æ–¹æ³•å</span>
      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">writeSymbol</span><span class="p">()</span> <span class="c1">#()</span>
      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">compileExpressionList</span><span class="p">()</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">writeSymbol</span><span class="p">()</span> <span class="c1">#)</span>
      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">writeSymbol</span><span class="p">()</span> <span class="c1">#;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">compileExpression</span>
    <span class="vi">@outputfile</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"&lt;expression&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">compileTerm</span><span class="p">()</span>
    <span class="n">termEnd</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="vg">$OPETATOR</span><span class="p">.</span><span class="nf">include?</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">symbol</span><span class="p">())</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">termEnd</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">writeSymbol</span><span class="p">()</span> <span class="c1">#æ“ä½œç¬¦</span>
      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">compileTerm</span><span class="p">()</span>
      <span class="n">termEnd</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="vg">$OPETATOR</span><span class="p">.</span><span class="nf">include?</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">symbol</span><span class="p">())</span>
    <span class="k">end</span>
    <span class="vi">@outputfile</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"&lt;/expression&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">compileExpressionList</span>
  <span class="o">...</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">compileTerm</span>
  <span class="o">...</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="è¯­ä¹‰åˆ†æå’Œä»£ç ç”Ÿæˆ">è¯­ä¹‰åˆ†æå’Œä»£ç ç”Ÿæˆ</h3>

<p>è¯­æ³•åˆ†æä¹Ÿæ˜¯è¯­ä¹‰åˆ†æçš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬çŸ¥é“äº†è¯­æ³•çš„ç±»å‹å°±çŸ¥é“äº†å®ƒæ‰€è¦è¡¨è¾¾çš„ä¸€éƒ¨åˆ†å«ä¹‰ï¼Œä¾‹å¦‚æˆ‘ä»¬çŸ¥é“äº†å®ƒæ˜¯ifæˆ–whileè¯­æ³•ï¼Œå°±çŸ¥é“å°†è¦è¿›è¡Œä¸€ç³»åˆ—çš„åˆ†æ”¯è·³è½¬æ“ä½œï¼›çŸ¥é“äº†å®ƒæ˜¯letè¯­æ³•ï¼Œå°±çŸ¥é“äº†éœ€è¦è¿›è¡Œèµ‹å€¼æ“ä½œï¼›çŸ¥é“äº†å®ƒæ˜¯doè¯­æ³•ï¼Œå°±çŸ¥é“äº†éœ€è¦è¿›è¡Œå‡½æ•°è°ƒç”¨æ“ä½œã€‚ä½†è¯­æ³•åˆ†æè¡¨è¾¾çš„è¯­ä¹‰è¿˜ä¸å®Œå…¨ï¼Œä¾‹å¦‚letè¯­å¥ä¸­èµ‹å€¼çš„å¯¹è±¡æ˜¯æˆå‘˜å˜é‡è¿˜æ˜¯é™æ€å˜é‡ï¼Ÿdoè¯­æ³•ä¸­è°ƒç”¨çš„å‡½æ•°æ˜¯ç±»æ–¹æ³•è¿˜æ˜¯å®ä¾‹æ–¹æ³•ï¼Ÿè¿™äº›éƒ½éœ€è¦æˆ‘ä»¬åœ¨è¯­ä¹‰åˆ†æè¿‡ç¨‹ä¸­æ¥è¿›ä¸€æ­¥åˆ¤æ–­ã€‚å½“æˆ‘ä»¬åˆ†æå‡ºä¸€ä¸ªè¯­å¥çš„è¯­ä¹‰çš„æ—¶å€™ï¼Œå°±å¯ä»¥ç”Ÿæˆå¯¹åº”çš„è™šæ‹Ÿæœºä»£ç äº†ï¼ˆåœ¨è¿™é‡Œè™šæ‹Ÿæœºè¯­è¨€å……å½“äº†ä¸­é—´è¯­è¨€ï¼Œæœ¬ç« çš„ç¼–è¯‘å™¨æ˜¯ç¼–è¯‘å™¨çš„å‰ç«¯ï¼Œè™šæ‹Ÿæœºåˆ™æ˜¯ç¼–è¯‘å™¨çš„åç«¯ï¼‰ï¼Œä¸”è¯­ä¹‰åˆ†æå’Œä»£ç ç”Ÿæˆæ˜¯å¯ä»¥åŒæ—¶è¿›è¡Œçš„ã€‚</p>

<p>ç¨‹åºçš„æœ¬è´¨å°±æ˜¯ä¸€ç³»åˆ—å¯¹æ•°æ®çš„æ“ä½œï¼Œæ‰€ä»¥æŠŠé«˜çº§è¯­è¨€ç¼–è¯‘æˆè¾ƒä½çº§çš„è¯­è¨€ä¸»è¦æ¶‰åŠä¸¤ä¸ªä¸»é¢˜ï¼š<strong>æ•°æ®çš„ç¿»è¯‘å’Œå‘½ä»¤çš„ç¿»è¯‘</strong>ã€‚</p>

<h3 id="æ•°æ®ç¿»è¯‘">æ•°æ®ç¿»è¯‘</h3>

<h4 id="å˜é‡">å˜é‡</h4>

<p>å˜é‡åä»£è¡¨äº†å†…å­˜ä¸­çš„æŸä¸ªåœ°å€ï¼Œæ˜¯é«˜çº§è¯­è¨€è®¿é—®å†…å­˜çš„æ¥å£ã€‚åœ¨Jackä¸­å˜é‡ç±»å‹åŒ…æ‹¬ï¼šé™æ€å˜é‡ã€æˆå‘˜å˜é‡ã€å±€éƒ¨å˜é‡å’Œå‚æ•°å˜é‡ã€‚åœ¨é«˜çº§è¯­è¨€ä¸­ï¼Œå˜é‡åç”¨å­—é¢é‡è¡¨ç¤ºï¼ˆidentifierï¼‰ï¼Œè€Œè™šæ‹Ÿæœºè¯­è¨€å¹¶ä¸è®¤è¯†è¿™äº›ç¬¦å·ï¼Œè™šæ‹Ÿæœºè¯­è¨€åªè®¤è¯† static 0ã€static 1ã€local 0ã€argument 1ã€this 0 ç­‰ç¬¦å·ï¼Œæ‰€ä»¥æ•°æ®ç¿»è¯‘éƒ¨åˆ†çš„å·¥ä½œå°±æ˜¯æŠŠé«˜çº§è¯­è¨€ä¸­çš„å˜é‡åç¿»è¯‘æˆâ€œæ®µå + indexâ€çš„æ ¼å¼ã€‚</p>

<h4 id="ç¬¦å·è¡¨">ç¬¦å·è¡¨</h4>

<p>å˜é‡ç¿»è¯‘çš„è¿‡ç¨‹åˆæ¶‰åŠåˆ°äº†ç¬¦å·è¡¨ã€‚åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å…ˆæŠŠç¬¦å·åŠ å…¥ç¬¦å·è¡¨ï¼Œç„¶ååœ¨åç»­çš„ç¼–è¯‘è¿‡ç¨‹ä¸­å¦‚æœé‡åˆ°äº†ç¬¦å·å°±å»ç¬¦å·è¡¨æŸ¥æ‰¾ç¬¦å·å¯¹åº”çš„typeï¼ˆå˜é‡ç±»å‹ï¼‰, kindï¼ˆå±äºå“ªä¸ªæ®µï¼‰å’Œindexã€‚</p>
<center><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcc32lf25ej30vw0ioq3h.jpg" width="500" /></center>

<p>ç¬¦å·è¡¨ä¸­key(ç¬¦å·)å’Œvalueçš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p>
<ol>
  <li>å±€éƒ¨å˜é‡åˆ†é…åˆ° local æ®µ</li>
  <li>é™æ€å˜é‡åˆ†é…åˆ° static æ®µ</li>
  <li>å‚æ•°å˜é‡åˆ†é…åˆ° argument æ®µ</li>
  <li>é€šè¿‡ this index çš„æ–¹å¼æ¥è®¿é—®æˆå‘˜å˜é‡</li>
  <li>é€šè¿‡ that index çš„æ–¹å¼æ¥è®¿é—®æ•°ç»„</li>
</ol>

<h4 id="ç¬¦å·è¡¨å®ç°">ç¬¦å·è¡¨å®ç°</h4>
<p>ç¬¦å·è¡¨çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯æ”¯æŒç¬¦å·çš„æ–°å¢å’ŒæŸ¥è¯¢åŠŸèƒ½ï¼Œä¸”éœ€è¦ç®¡ç†æ¯ä¸ªæ®µçš„indexï¼ˆæ®µä¸­æ–°å¢äº†å˜é‡åindexéœ€è¦+1ï¼‰ã€‚</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>startSubroutineï¼šç¬¦å·è¡¨é‡ç½®ï¼Œå¼€è¾Ÿæ–°çš„å­ç¨‹åºä½œç”¨åŸŸ
define         ï¼šæ–°å¢ä¸€æ¡ç¬¦å·
varCount       ï¼šç¬¦å·è¡¨ä¸­æŸKindçš„å˜é‡æ•°é‡
kindOf         ï¼šæŸç¬¦å·çš„kind
typeOf         ï¼šæŸç¬¦å·çš„type
indexOf        ï¼šæŸç¬¦å·çš„index
</pre></td></tr></tbody></table></code></pre></div></div>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">SymbolTable</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="vi">@classTable</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="vi">@subroutineTable</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="vi">@symbolTableDic</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"static"</span> <span class="o">=&gt;</span> <span class="vi">@classTable</span><span class="p">,</span> <span class="s2">"field"</span> <span class="o">=&gt;</span> <span class="vi">@classTable</span><span class="p">,</span> <span class="s2">"arg"</span> <span class="o">=&gt;</span> <span class="vi">@subroutineTable</span><span class="p">,</span> <span class="s2">"var"</span> <span class="o">=&gt;</span> <span class="vi">@subroutineTable</span><span class="p">}</span>
    <span class="vi">@segementDic</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"static"</span> <span class="o">=&gt;</span> <span class="s2">"static"</span><span class="p">,</span> <span class="s2">"field"</span> <span class="o">=&gt;</span> <span class="s2">"field"</span><span class="p">,</span> <span class="s2">"arg"</span> <span class="o">=&gt;</span> <span class="s2">"argument"</span><span class="p">,</span> <span class="s2">"var"</span> <span class="o">=&gt;</span> <span class="s2">"local"</span><span class="p">}</span>
    <span class="vi">@symbolIndex</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"static"</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"field"</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"arg"</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"var"</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">startSubroutine</span><span class="p">()</span>
    <span class="vi">@subroutineTable</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span> <span class="c1">#æ¸…ç©ºsubroutineTableï¼Œå¼€å§‹ç¼–è¯‘ä¸‹ä¸€ä¸ªæ–¹æ³•</span>
    <span class="vi">@symbolIndex</span><span class="p">[</span><span class="s2">"arg"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="vi">@symbolIndex</span><span class="p">[</span><span class="s2">"var"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">kind</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"å­˜å…¥ç¬¦å·è¡¨, name:</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">, type:</span><span class="si">#{</span><span class="n">type</span><span class="si">}</span><span class="s2">, kind:</span><span class="si">#{</span><span class="n">kind</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">symbolTable</span> <span class="o">=</span> <span class="vi">@symbolTableDic</span><span class="p">[</span><span class="n">kind</span><span class="p">]</span>
    <span class="n">symbolTable</span><span class="p">[</span><span class="nb">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">type</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="vi">@symbolIndex</span><span class="p">[</span><span class="n">kind</span><span class="p">]]</span>
    <span class="vi">@symbolIndex</span><span class="p">[</span><span class="n">kind</span><span class="p">]</span> <span class="o">=</span> <span class="vi">@symbolIndex</span><span class="p">[</span><span class="n">kind</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">varCount</span><span class="p">(</span><span class="n">kind</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="vi">@classTable</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">values</span><span class="o">|</span>
      <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">kind</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="vi">@subroutineTable</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">values</span><span class="o">|</span>
      <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">kind</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">count</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">kindOf</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="n">valus</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">findSymbol</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="vi">@segementDic</span><span class="p">[</span><span class="n">valus</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">typeOf</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="n">valus</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">findSymbol</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">valus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">indexOf</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="n">valus</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">findSymbol</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">valus</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">findSymbol</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@subroutineTable</span><span class="p">.</span><span class="nf">key?</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
      <span class="k">return</span> <span class="vi">@subroutineTable</span><span class="p">[</span><span class="nb">name</span><span class="p">]</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="vi">@classTable</span><span class="p">.</span><span class="nf">key?</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
      <span class="k">return</span> <span class="vi">@classTable</span><span class="p">[</span><span class="nb">name</span><span class="p">]</span>
    <span class="k">end</span>

    <span class="k">return</span> <span class="p">[</span><span class="s2">"NONE"</span><span class="p">,</span> <span class="s2">"NONE"</span><span class="p">,</span> <span class="s2">"NONE"</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">printSymbols</span>
    <span class="nb">puts</span> <span class="s2">"classTable: </span><span class="si">#{</span><span class="vi">@classTable</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">puts</span> <span class="s2">"subroutineTable: </span><span class="si">#{</span><span class="vi">@subroutineTable</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">puts</span> <span class="s2">"symbolIndex: </span><span class="si">#{</span><span class="vi">@symbolIndex</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ç”±äºJackçš„é€‚å½“è®¾è®¡ï¼Œæˆ‘ä»¬ä¸ä¼šé‡åˆ°åœ¨åµŒå¥—çš„ä½œç”¨åŸŸä¸­ä½¿ç”¨å˜é‡çš„æƒ…å†µï¼Œæ‰€ä»¥ä¸ä¼šé‡åˆ°å˜é‡å†²çªçš„é—®é¢˜ã€‚åœ¨å…¶ä»–é«˜çº§è¯­è¨€ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šéšæ—¶å¼€è¾Ÿä¸€ä¸ªæ–°çš„ä½œç”¨åŸŸï¼ˆä¾‹å¦‚ç”¨{}æ‹¬èµ·æ¥ï¼‰ï¼Œè¿™æ—¶å€™æˆ‘ä»¬éœ€è¦ç”¨ç¬¦å·è¡¨çš„é“¾è¡¨è¿™ç§æ•°æ®ç»“æ„æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ¯å¢åŠ ä¸€å±‚ä½œç”¨åŸŸéƒ½ä¼šæ–°å¢ä¸€ä¸ªæ–°çš„ç¬¦å·è¡¨èŠ‚ç‚¹ã€‚</p>

<h4 id="å¤„ç†ç¬¦å·">å¤„ç†ç¬¦å·</h4>
<p>ä¸‹é¢æˆªå–äº†ä¸€æ®µç¬¦å·å¤„ç†çš„å®ç°ï¼ˆæŠŠç¬¦å·åŠ å…¥ç¬¦å·è¡¨ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°è¯­ä¹‰åˆ†æå’Œä»£ç ç”Ÿæˆçš„é˜¶æ®µæ˜¯èåˆåœ¨è¯­æ³•åˆ†æçš„è¿‡ç¨‹å½“ä¸­çš„ï¼Œæ˜¯å¯¹è¯­æ³•åˆ†æç¨‹åºçš„æ‰©å±•ã€‚åœ¨è¯­æ³•åˆ†æè¿‡ç¨‹ä¸­ï¼Œå½“æˆ‘ä»¬é‡åˆ°ä¸€ä¸ªæ–°ç¬¦å·ï¼Œæˆ‘ä»¬å…ˆè§£æå®ƒçš„typeå’Œkindï¼Œç„¶åæŠŠå®ƒå†™åˆ°ç¬¦å·è¡¨ä¸­ã€‚</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="rouge-code"><pre><span class="c1">#ç¼–è¯‘é™æ€å˜é‡æˆ–æˆå‘˜å˜é‡çš„å£°æ˜</span>
<span class="k">def</span> <span class="nf">compileClassVarDec</span>
  <span class="n">varCount</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">isVar</span> <span class="o">=</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">tokenType</span> <span class="o">==</span> <span class="s2">"KEYWORD"</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">keyword</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"static"</span> <span class="o">||</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">keyword</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"field"</span><span class="p">)</span>
  <span class="k">while</span> <span class="n">isVar</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="n">getKeyword</span><span class="p">()</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="n">type</span> <span class="o">=</span> <span class="n">getType</span><span class="p">()</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="n">varCount</span> <span class="o">=</span> <span class="n">varCount</span> <span class="o">+</span> <span class="nb">self</span><span class="p">.</span><span class="nf">writeVarToSymbolTable</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">type</span><span class="p">)</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="n">isVar</span> <span class="o">=</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">tokenType</span> <span class="o">==</span> <span class="s2">"KEYWORD"</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">keyword</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"static"</span> <span class="o">||</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">keyword</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"field"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="k">return</span>
<span class="k">end</span>

<span class="c1">#ç¼–è¯‘å±€éƒ¨å˜é‡</span>
<span class="k">def</span> <span class="nf">compileVarDec</span>
  <span class="n">varCount</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">isVar</span> <span class="o">=</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">tokenType</span> <span class="o">==</span> <span class="s2">"KEYWORD"</span> <span class="o">&amp;&amp;</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">keyword</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"var"</span>
  <span class="k">while</span> <span class="n">isVar</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="n">getKeyword</span><span class="p">()</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="n">type</span> <span class="o">=</span> <span class="n">getType</span><span class="p">()</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="n">varCount</span> <span class="o">=</span> <span class="n">varCount</span> <span class="o">+</span> <span class="nb">self</span><span class="p">.</span><span class="nf">writeVarToSymbolTable</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">type</span><span class="p">)</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="n">isVar</span> <span class="o">=</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">tokenType</span> <span class="o">==</span> <span class="s2">"KEYWORD"</span> <span class="o">&amp;&amp;</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">keyword</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"var"</span>
  <span class="k">end</span>
  <span class="k">return</span> <span class="n">varCount</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">writeVarToSymbolTable</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">type</span><span class="p">)</span>
  <span class="n">varCount</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">firstVarName</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">getIndentifier</span><span class="p">()</span>
  <span class="vi">@symbolTable</span><span class="p">.</span><span class="nf">define</span><span class="p">(</span><span class="n">firstVarName</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">kind</span><span class="p">)</span>
  <span class="n">varCount</span> <span class="o">=</span> <span class="n">varCount</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="n">isSemicolon</span> <span class="o">=</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">tokenType</span> <span class="o">==</span> <span class="s2">"SYMBOL"</span> <span class="o">&amp;&amp;</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">symbol</span><span class="p">()</span> <span class="o">==</span> <span class="s2">";"</span>
  <span class="k">while</span> <span class="o">!</span><span class="n">isSemicolon</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="n">nextVarName</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">getIndentifier</span><span class="p">()</span>
    <span class="vi">@symbolTable</span><span class="p">.</span><span class="nf">define</span><span class="p">(</span><span class="n">nextVarName</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">kind</span><span class="p">)</span>
    <span class="n">varCount</span> <span class="o">=</span> <span class="n">varCount</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="n">isSemicolon</span> <span class="o">=</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">tokenType</span> <span class="o">==</span> <span class="s2">"SYMBOL"</span> <span class="o">&amp;&amp;</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">symbol</span><span class="p">()</span> <span class="o">==</span> <span class="s2">";"</span>
  <span class="k">end</span>
  <span class="k">return</span> <span class="n">varCount</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="å‘½ä»¤ç¿»è¯‘">å‘½ä»¤ç¿»è¯‘</h3>

<p>å‘½ä»¤ç¿»è¯‘éƒ¨åˆ†ï¼Œæˆ‘ä»¬éœ€è¦å¤„ç†ä¸¤ç±»å‘½ä»¤ï¼šè¡¨è¾¾å¼æ±‚å€¼å’Œç¨‹åºæµç¨‹æ§åˆ¶</p>

<h4 id="è¡¨è¾¾å¼æ±‚å€¼">è¡¨è¾¾å¼æ±‚å€¼</h4>

<p>è¡¨è¾¾å¼æ±‚å€¼å°±æ˜¯è®¡ç®—å½¢å¦‚ï¼šx+g(x,y,-z)*5çš„è®¡ç®—å¼ï¼Œè®¡ç®—è¿™ç§è¡¨è¾¾å¼å¯ä»¥ç”¨ç»å…¸çš„åç¼€è¡¨ç¤ºæ³•æ¥å¤„ç†ï¼ˆRPNï¼Œé€†æ³¢å…°è¡¨ç¤ºæ³•ï¼‰ï¼Œå³é€šè¿‡ååºéå†çš„æ–¹å¼ç»“åˆæ ˆçš„ä½¿ç”¨æ¥è®¡ç®—è¡¨è¾¾å¼ã€‚</p>

<center><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcc7a0oblqj31fw0no3zx.jpg" width="800" /></center>

<p>ç”¨ç¨‹åºè¡¨è¾¾åç¼€è¡¨è¾¾å¼çš„ç®—æ³•å¦‚ä¸‹ï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>compileExpression(exp)
{
if exp æ˜¯æ•°å­— n                  then push n
if exp æ˜¯å˜é‡ v                  then push v
if exp = (exp1 op exp2)         then compileExpression(exp1), compileExpression(exp2), compile op 
if exp = op(exp1)               then compileExpression(exp1), compile op 
if exp = f(exp1 ... expN)       then compileExpression(exp1), ..., compileExpression(expn), call f
}
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="è¡¨è¾¾å¼å®ç°">è¡¨è¾¾å¼å®ç°</h4>
<p>ç”¨ç¨‹åºè¡¨è¾¾åç¼€è¡¨è¾¾å¼çš„ç®—æ³•æœ¬èº«æ¯”è¾ƒç®€ç­”ï¼Œä½†è¡¨è¾¾å¼æœ¬èº«æ¯”è¾ƒå¤æ‚ï¼Œåœ¨Jackä¸­å¾ˆå¤šç¬¦å·æˆ–ç¬¦å·çš„ç»„åˆéƒ½å¯ä»¥è¢«å½“åšä¸€ä¸ªè¡¨è¾¾å¼ï¼Œä¾‹å¦‚ä¸€ä¸ªè¡¨è¾¾å¼å¯ä»¥æ˜¯ä¸€ä¸ªå…³é”®å­—ï¼Œä¸€ä¸ªæ•°å­—ï¼Œä¸€ä¸ªå˜é‡ï¼›ä¹Ÿå¯ä»¥æ˜¯æ•°ç»„ä¸­çš„æŸä¸ªå€¼ï¼›ä¹Ÿå¯ä»¥æ˜¯å‡½æ•°è°ƒç”¨ï¼›ä¹Ÿå¯ä»¥æ˜¯ç”¨ï¼ˆï¼‰æ‹¬èµ·æ¥çš„å¦ä¸€ä¸ªè¡¨è¾¾å¼ç­‰ï¼Œæˆ‘ä»¬æŠŠè¿™äº›å¯èƒ½çš„æ–¹å¼éƒ½ç»Ÿç§°ä¸ºä¸€ä¸ªtermã€‚è¡¨è¾¾å¼å®ç°çš„å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">compileExpression</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">compileTerm</span><span class="p">()</span>
  <span class="n">termEnd</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="vg">$OPETATOR</span><span class="p">.</span><span class="nf">include?</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">symbol</span><span class="p">())</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">termEnd</span>
    <span class="n">opretator</span> <span class="o">=</span> <span class="vg">$OPTOCMD</span><span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="nf">getSymbol</span><span class="p">()]</span> <span class="c1">#æ“ä½œç¬¦</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">compileTerm</span><span class="p">()</span>
    <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeArithmetic</span><span class="p">(</span><span class="n">opretator</span><span class="p">)</span>
    <span class="n">termEnd</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="vg">$OPETATOR</span><span class="p">.</span><span class="nf">include?</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">symbol</span><span class="p">())</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">compileTerm</span>
  <span class="k">if</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">symbol</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"-"</span> <span class="o">||</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">symbol</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"~"</span> <span class="c1">#unary term</span>
    <span class="n">opetator</span> <span class="o">=</span> <span class="vg">$UNARYCMD</span><span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="nf">getSymbol</span><span class="p">()]</span> 
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">compileTerm</span><span class="p">()</span>
    <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeArithmetic</span><span class="p">(</span><span class="n">opetator</span><span class="p">)</span>
  <span class="k">elsif</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">tokenType</span> <span class="o">==</span> <span class="s2">"KEYWORD"</span>
    <span class="n">keyword</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">getKeyword</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s2">"false"</span> <span class="o">||</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s2">"null"</span>
      <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePushNumber</span><span class="p">(</span><span class="s2">"0"</span><span class="p">)</span>
    <span class="k">elsif</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s2">"true"</span>
      <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePushNumber</span><span class="p">(</span><span class="s2">"0"</span><span class="p">)</span>
      <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeArithmetic</span><span class="p">(</span><span class="s2">"not"</span><span class="p">)</span> <span class="c1">#-1ä»£è¡¨true</span>
    <span class="k">elsif</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s2">"this"</span>
      <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePush</span><span class="p">(</span><span class="s2">"pointer"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">raise</span> <span class="s2">"</span><span class="si">#{</span><span class="n">keyword</span><span class="si">}</span><span class="s2">æ˜¯ä¸å¯è¯†åˆ«ç¬¦å·ï¼ˆåªè¯†åˆ«ture, false, nullï¼‰"</span>
    <span class="k">end</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="k">elsif</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">tokenType</span> <span class="o">==</span> <span class="s2">"INT-CONST"</span>
    <span class="n">number</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">getNumber</span><span class="p">()</span>
    <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePushNumber</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="k">elsif</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">tokenType</span> <span class="o">==</span> <span class="s2">"STRING-CONST"</span>
    <span class="n">string</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">getString</span><span class="p">()</span>
    <span class="nb">puts</span> <span class="s2">"å‘ç°stringï¼š</span><span class="si">#{</span><span class="n">string</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">processString</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="k">elsif</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">symbol</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"("</span> <span class="c1">#(expression)</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">compileExpression</span><span class="p">()</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="k">else</span> <span class="c1">#varName | varName[expression] | subroutineCall</span>
    <span class="n">firstToken</span> <span class="o">=</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">identifier</span><span class="p">()</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="n">secondToken</span> <span class="o">=</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">symbol</span><span class="p">()</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">backward</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">secondToken</span> <span class="o">!=</span> <span class="s2">"["</span> <span class="o">&amp;&amp;</span> <span class="n">secondToken</span> <span class="o">!=</span> <span class="s2">"("</span> <span class="o">&amp;&amp;</span> <span class="n">secondToken</span> <span class="o">!=</span> <span class="s2">"."</span> <span class="c1">#varName</span>
      <span class="n">varName</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">getIndentifier</span><span class="p">()</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">pushVarName</span><span class="p">(</span><span class="n">varName</span><span class="p">)</span>
      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="k">elsif</span> <span class="n">secondToken</span> <span class="o">==</span> <span class="s2">"["</span> <span class="c1">#varName[expression]</span>
      <span class="n">varName</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">getIndentifier</span><span class="p">()</span>
      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">compileExpression</span><span class="p">()</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">pushVarName</span><span class="p">(</span><span class="n">varName</span><span class="p">)</span>
      <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeArithmetic</span><span class="p">(</span><span class="s2">"add"</span><span class="p">)</span>
      <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePop</span><span class="p">(</span><span class="s2">"pointer"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">#ä¿®æ”¹That</span>
      <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePush</span><span class="p">(</span><span class="s2">"that"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="k">elsif</span> <span class="n">secondToken</span> <span class="o">==</span> <span class="s2">"("</span> <span class="o">||</span> <span class="n">secondToken</span> <span class="o">==</span> <span class="s2">"."</span> <span class="c1">#subroutineCall</span>
      <span class="n">firstSymbol</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">getIndentifier</span><span class="p">()</span>
      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
      <span class="k">if</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">symbol</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"("</span> <span class="c1">#è°ƒå†…éƒ¨æ–¹æ³•åˆ†æ”¯</span>
        <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
        <span class="n">paramCount</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">compileExpressionList</span><span class="p">()</span>
        <span class="n">methodName</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="vi">@className</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="n">firstSymbol</span><span class="si">}</span><span class="s2">"</span>
        <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePush</span><span class="p">(</span><span class="s2">"pointer"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">#è°ƒç”¨å®ä¾‹æ–¹æ³•ï¼Œå…ˆpushè‡ªå·±</span>
        <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeCall</span><span class="p">(</span><span class="n">methodName</span><span class="p">,</span> <span class="n">paramCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
      <span class="k">elsif</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">symbol</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"."</span> <span class="c1">#è°ƒå¤–éƒ¨æ–¹æ³•åˆ†æ”¯</span>
        <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
        <span class="n">className</span> <span class="o">=</span> <span class="n">firstSymbol</span>
        <span class="n">methodName</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">getIndentifier</span><span class="p">()</span> 
        <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
        <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
        <span class="n">symbolKind</span> <span class="o">=</span> <span class="vi">@symbolTable</span><span class="p">.</span><span class="nf">kindOf</span><span class="p">(</span><span class="n">firstSymbol</span><span class="p">)</span>
        <span class="n">symbolIndex</span> <span class="o">=</span> <span class="vi">@symbolTable</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="n">firstSymbol</span><span class="p">)</span>
        <span class="n">isInstanceMethod</span> <span class="o">=</span> <span class="n">symbolKind</span> <span class="o">!=</span> <span class="s2">"NONE"</span> <span class="o">&amp;&amp;</span> <span class="n">symbolIndex</span> <span class="o">!=</span> <span class="s2">"NONE"</span>
        <span class="k">if</span>  <span class="n">isInstanceMethod</span> <span class="c1">#è°ƒç”¨å®ä¾‹çš„æ–¹æ³•</span>
          <span class="k">if</span> <span class="n">symbolKind</span> <span class="o">==</span> <span class="s2">"field"</span>
            <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePush</span><span class="p">(</span><span class="s2">"this"</span><span class="p">,</span> <span class="n">symbolIndex</span><span class="p">)</span> <span class="c1">#push this</span>
          <span class="k">else</span>
            <span class="k">if</span> <span class="vi">@curFunctionType</span> <span class="o">==</span> <span class="s2">"method"</span> <span class="o">&amp;&amp;</span> <span class="n">symbolKind</span> <span class="o">==</span> <span class="s2">"argument"</span>
              <span class="n">symbolIndex</span> <span class="o">=</span> <span class="n">symbolIndex</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">end</span>
            <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePush</span><span class="p">(</span><span class="n">symbolKind</span><span class="p">,</span> <span class="n">symbolIndex</span><span class="p">)</span>
          <span class="k">end</span>
          <span class="n">className</span> <span class="o">=</span> <span class="vi">@symbolTable</span><span class="p">.</span><span class="nf">typeOf</span><span class="p">(</span><span class="n">firstSymbol</span><span class="p">)</span>
        <span class="k">end</span>
        <span class="n">paramCount</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">compileExpressionList</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">isInstanceMethod</span>
          <span class="n">paramCount</span> <span class="o">=</span> <span class="n">paramCount</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">end</span>
        <span class="n">callName</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="n">className</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="n">methodName</span><span class="si">}</span><span class="s2">"</span>
        <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeCall</span><span class="p">(</span><span class="n">callName</span><span class="p">,</span> <span class="n">paramCount</span><span class="p">)</span>
        <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="åˆ†æ”¯æµç¨‹æ§åˆ¶">åˆ†æ”¯æµç¨‹æ§åˆ¶</h4>

<p>è¿™é‡Œçš„åˆ†æ”¯æµç¨‹æ§åˆ¶æŒ‡çš„å°±æ˜¯Jackä¸­çš„ifè¯­å¥å’Œwhileè¯­å¥ã€‚åˆ†æ”¯æµç¨‹æ§åˆ¶çš„ç¼–è¯‘ç›¸å¯¹æ›´ç›´è§‚ä¸€ç‚¹ï¼Œå°±æ˜¯æŠŠifå’Œwhileè¯­å¥ç¼–è¯‘æˆæ›´ä½çº§çš„gotoå’Œif-gotoè¯­å¥ã€‚å®ƒä»¬çš„å®ç°ç®—æ³•å¦‚ä¸‹ï¼š</p>
<center><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcchm1dj93j31di0u00ug.jpg" width="800" /></center>

<p>å…³é”®ä»£ç å®ç°å¦‚ä¸‹ï¼Œè¿™é‡Œå€¼å¾—æ€è€ƒçš„æ˜¯ï¼šå¦‚ä½•ä¿è¯label L1, label L2ç­‰labelåä¸äº’ç›¸å†²çªï¼›ä¸”ifå’Œwhileæ˜¯å¯ä»¥å…·å¤‡åµŒå¥—ç»“æ„çš„ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ç¡®ä¿è¿›å…¥æˆ–é€€å‡ºæ—¶æ›´æ·±ä¸€çº§ifæˆ–whileè¯­å¥æ—¶ï¼Œlabelçš„å¯¹åº”å…³ç³»ä¸ä¼šæ··ä¹±ã€‚</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">compileIF</span>
  <span class="vi">@ifBackTrace</span> <span class="o">&lt;&lt;</span> <span class="vi">@ifCount</span>
  <span class="vi">@ifTotle</span> <span class="o">=</span> <span class="vi">@ifTotle</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="vi">@ifCount</span> <span class="o">=</span> <span class="vi">@ifTotle</span>
  <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">compileExpression</span><span class="p">()</span>
  <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeIf</span><span class="p">(</span><span class="s2">"IF_TRUE</span><span class="si">#{</span><span class="vi">@ifCount</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeGoto</span><span class="p">(</span><span class="s2">"IF_FALSE</span><span class="si">#{</span><span class="vi">@ifCount</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeLabel</span><span class="p">(</span><span class="s2">"IF_TRUE</span><span class="si">#{</span><span class="vi">@ifCount</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">compileStatements</span><span class="p">()</span>
  <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="k">if</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">keyword</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"else"</span> <span class="c1">#compile else</span>
    <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeGoto</span><span class="p">(</span><span class="s2">"IF_END</span><span class="si">#{</span><span class="vi">@ifCount</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeLabel</span><span class="p">(</span><span class="s2">"IF_FALSE</span><span class="si">#{</span><span class="vi">@ifCount</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">compileStatements</span><span class="p">()</span>
    <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeLabel</span><span class="p">(</span><span class="s2">"IF_END</span><span class="si">#{</span><span class="vi">@ifCount</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">backward</span><span class="p">()</span> <span class="c1">#è¿”å›åˆ°}å¤„</span>
    <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeLabel</span><span class="p">(</span><span class="s2">"IF_FALSE</span><span class="si">#{</span><span class="vi">@ifCount</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="vi">@ifCount</span> <span class="o">=</span> <span class="vi">@ifBackTrace</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">compileWhile</span>
  <span class="vi">@whileBackTrace</span> <span class="o">&lt;&lt;</span> <span class="vi">@whileCount</span>
  <span class="vi">@whileTotle</span> <span class="o">=</span> <span class="vi">@whileTotle</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="vi">@whileCount</span> <span class="o">=</span> <span class="vi">@whileTotle</span>
  <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeLabel</span><span class="p">(</span><span class="s2">"WHILE_EXP</span><span class="si">#{</span><span class="vi">@whileCount</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">compileExpression</span><span class="p">()</span>
  <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeArithmetic</span><span class="p">(</span><span class="s2">"not"</span><span class="p">)</span>
  <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeIf</span><span class="p">(</span><span class="s2">"WHILE_END</span><span class="si">#{</span><span class="vi">@whileCount</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">compileStatements</span><span class="p">()</span>
  <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeGoto</span><span class="p">(</span><span class="s2">"WHILE_EXP</span><span class="si">#{</span><span class="vi">@whileCount</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeLabel</span><span class="p">(</span><span class="s2">"WHILE_END</span><span class="si">#{</span><span class="vi">@whileCount</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="vi">@whileCount</span> <span class="o">=</span> <span class="vi">@whileBackTrace</span><span class="p">.</span><span class="nf">pop</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<h4 id="å‡½æ•°è°ƒç”¨å’Œè¿”å›">å‡½æ•°è°ƒç”¨å’Œè¿”å›</h4>

<p>åœ¨è°ƒç”¨VMå‡½æ•°ä¹‹å‰ï¼Œè°ƒç”¨è€…å¿…é¡»å°†å‡½æ•°çš„å‚å…¥å‹å…¥æ ˆï¼Œä¸”å¦‚æœè¢«è°ƒç”¨çš„VMå‡½æ•°æ˜¯è‡ªå·±å®ä¾‹æ–¹æ³•ï¼Œé‚£ä¹ˆé¦–å…ˆå…¥æ ˆçš„å‚æ•°æ˜¯è¯¥æ–¹æ³•æ“ä½œå¯¹è±¡çš„å¼•ç”¨ï¼ˆè¿›å…¥å‡½æ•°åè¿™ä¸ªå¯¹è±¡å¼•ç”¨å˜ä¸ºthisæŒ‡é’ˆï¼‰ã€‚returnæ–¹æ³•çš„å®ç°åˆ™å¾ˆç®€å•ï¼Œä¸è¿‡å½“returnçš„ç±»å‹ä¸ºvoidæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦è¿”å›ä¸€ä¸ªå¸¸é‡0ä½œä¸ºè¿”å›å€¼ã€‚</p>

<p>ä»£ç å…³é”®å®ç°å¦‚ä¸‹ï¼š</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">compileSubroutineCall</span>
  <span class="n">isVoid</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="n">firstSymbol</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">getIndentifier</span><span class="p">()</span>
  <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="k">if</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">symbol</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"("</span> <span class="c1">#è°ƒå†…éƒ¨æ–¹æ³•åˆ†æ”¯</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePush</span><span class="p">(</span><span class="s2">"pointer"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">#è°ƒç”¨å®ä¾‹æ–¹æ³•ï¼Œå…ˆpush this</span>
    <span class="n">paramCount</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">compileExpressionList</span><span class="p">()</span>
    <span class="n">methodName</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="vi">@className</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="n">firstSymbol</span><span class="si">}</span><span class="s2">"</span>
    <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeCall</span><span class="p">(</span><span class="n">methodName</span><span class="p">,</span> <span class="n">paramCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="k">elsif</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">symbol</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"."</span> <span class="c1">#è°ƒå¤–éƒ¨æ–¹æ³•åˆ†æ”¯</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="n">className</span> <span class="o">=</span> <span class="n">firstSymbol</span>
    <span class="n">methodName</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">getIndentifier</span><span class="p">()</span> 
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="n">symbolKind</span> <span class="o">=</span> <span class="vi">@symbolTable</span><span class="p">.</span><span class="nf">kindOf</span><span class="p">(</span><span class="n">firstSymbol</span><span class="p">)</span>
    <span class="n">symbolIndex</span> <span class="o">=</span> <span class="vi">@symbolTable</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="n">firstSymbol</span><span class="p">)</span>
    <span class="n">isInstanceMethod</span> <span class="o">=</span> <span class="n">symbolKind</span> <span class="o">!=</span> <span class="s2">"NONE"</span> <span class="o">&amp;&amp;</span> <span class="n">symbolIndex</span> <span class="o">!=</span> <span class="s2">"NONE"</span>
    <span class="k">if</span>  <span class="n">isInstanceMethod</span> <span class="c1">#è°ƒç”¨å®ä¾‹çš„æ–¹æ³•</span>
      <span class="k">if</span> <span class="n">symbolKind</span> <span class="o">==</span> <span class="s2">"field"</span>
        <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePush</span><span class="p">(</span><span class="s2">"this"</span><span class="p">,</span> <span class="n">symbolIndex</span><span class="p">)</span> <span class="c1">#push this</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="vi">@curFunctionType</span> <span class="o">==</span> <span class="s2">"method"</span> <span class="o">&amp;&amp;</span> <span class="n">symbolKind</span> <span class="o">==</span> <span class="s2">"argument"</span>
          <span class="n">symbolIndex</span> <span class="o">=</span> <span class="n">symbolIndex</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">end</span>
        <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePush</span><span class="p">(</span><span class="n">symbolKind</span><span class="p">,</span> <span class="n">symbolIndex</span><span class="p">)</span>
      <span class="k">end</span>
      <span class="n">className</span> <span class="o">=</span> <span class="vi">@symbolTable</span><span class="p">.</span><span class="nf">typeOf</span><span class="p">(</span><span class="n">firstSymbol</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">paramCount</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">compileExpressionList</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">isInstanceMethod</span>
      <span class="n">paramCount</span> <span class="o">=</span> <span class="n">paramCount</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">end</span>
    <span class="n">callName</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="n">className</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="n">methodName</span><span class="si">}</span><span class="s2">"</span>
    <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeCall</span><span class="p">(</span><span class="n">callName</span><span class="p">,</span> <span class="n">paramCount</span><span class="p">)</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">compileReturn</span>
  <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="k">if</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">symbol</span><span class="p">()</span> <span class="o">==</span> <span class="s2">";"</span> <span class="c1">#æ•°ç»„</span>
    <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePushNumber</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#é»˜è®¤push0</span>
    <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeReturn</span><span class="p">()</span> <span class="c1">#return</span>
  <span class="k">else</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">compileExpression</span><span class="p">()</span>
    <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeReturn</span><span class="p">()</span> <span class="c1">#return</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="å¯¹è±¡è®¿é—®">å¯¹è±¡è®¿é—®</h3>

<p>ä¸Šè¿°æˆ‘ä»¬è®²çš„æ“ä½œéƒ½æ˜¯å‘ç”Ÿåœ¨æ ˆç©ºé—´ï¼Œè€Œå¯¹è±¡å’Œæ•°ç»„å­˜å‚¨çš„å†…å­˜ä½ç½®åœ¨å †ç©ºé—´ã€‚å¯¹è±¡å’Œæ•°ç»„çš„å¤„ç†æ–¹å¼å¾ˆç±»ä¼¼ï¼Œéƒ½æ˜¯åœ¨å†…å­˜ä¸­ä¸ºå…¶åˆ†é…ä¸€å—è¿ç»­çš„å†…å­˜ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªæŒ‡å‘èµ·å§‹åœ°å€çš„æŒ‡é’ˆæ¥è¿›è¡Œè®¿é—®ã€‚</p>
<center><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcd3nvaw6kj30ke11g75d.jpg" width="300" /></center>

<p>thisæŒ‡é’ˆåœ¨å¯¹è±¡è®¿é—®ä¸­èµ·åˆ°äº†é‡è¦ä½œç”¨ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ç³»ç»Ÿçš„Memory.alloc()å‡½æ•°æ¥ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ï¼ŒMemory.alloc()è¿”å›æŒ‡å‘å¯¹è±¡èµ·å§‹åœ°å€çš„æŒ‡é’ˆï¼Œç„¶åæˆ‘ä»¬æŠŠè¿™ä¸ªæŒ‡é’ˆèµ‹å€¼ç»™THISæ®µï¼Œè¿”å›ç»™è°ƒç”¨è€…ã€‚</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="n">constructor</span> <span class="nc">Ball</span> <span class="nf">new</span><span class="o">(</span><span class="kt">int</span> <span class="nc">Ax</span><span class="o">,</span> <span class="kt">int</span> <span class="nc">Ay</span><span class="o">,</span>
                     <span class="kt">int</span> <span class="nc">AleftWall</span><span class="o">,</span> <span class="kt">int</span> <span class="nc">ArightWall</span><span class="o">,</span> <span class="kt">int</span> <span class="nc">AtopWall</span><span class="o">,</span> <span class="kt">int</span> <span class="nc">AbottomWall</span><span class="o">)</span> <span class="o">{</span>      
  <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="nc">Ax</span><span class="o">;</span>   
  <span class="n">let</span> <span class="n">y</span> <span class="o">=</span> <span class="nc">Ay</span><span class="o">;</span>
  <span class="n">let</span> <span class="n">leftWall</span> <span class="o">=</span> <span class="nc">AleftWall</span><span class="o">;</span>
  <span class="n">let</span> <span class="n">rightWall</span> <span class="o">=</span> <span class="nc">ArightWall</span> <span class="o">-</span> <span class="mi">6</span><span class="o">;</span>
  <span class="n">let</span> <span class="n">topWall</span> <span class="o">=</span> <span class="nc">AtopWall</span><span class="o">;</span> 
  <span class="n">let</span> <span class="n">bottomWall</span> <span class="o">=</span> <span class="nc">AbottomWall</span> <span class="o">-</span> <span class="mi">6</span><span class="o">;</span>
  <span class="n">let</span> <span class="n">wall</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="k">do</span> <span class="nf">show</span><span class="o">();</span>

  <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c1"># ç¼–è¯‘æ„é€ å‡½æ•°ï¼Œå¼€è¾Ÿå®ä¾‹å†…å­˜</span>
<span class="k">def</span> <span class="nf">compileConstructor</span>
  <span class="n">filedCount</span> <span class="o">=</span> <span class="vi">@symbolTable</span><span class="p">.</span><span class="nf">varCount</span><span class="p">(</span><span class="s2">"field"</span><span class="p">)</span>
  <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePushNumber</span><span class="p">(</span><span class="n">filedCount</span><span class="p">)</span>       <span class="c1">#é¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“å¯¹è±¡éœ€è¦å¤šå¤§çš„å†…å­˜ï¼Œå³éœ€è¦å­˜å‚¨å¤šå°‘ä¸ªå˜é‡</span>
  <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeCall</span><span class="p">(</span><span class="s2">"Memory.alloc"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePop</span><span class="p">(</span><span class="s2">"pointer"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>            <span class="c1">#æŠŠå®ä¾‹å†…å­˜åœ°å€popåˆ°THIS</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>å½“æˆ‘ä»¬è°ƒç”¨å¯¹è±¡çš„å®ä¾‹æ–¹æ³•æ—¶ï¼Œéœ€è¦å…ˆpushå®ä¾‹æ–¹æ³•çš„å…¥å‚ï¼Œä½†æˆ‘ä»¬é¦–å…ˆéœ€è¦pushä¸€ä¸ªé¢å¤–çš„éšå«å‚æ•°ï¼Œå°±æ˜¯è°ƒç”¨å¯¹è±¡æœ¬èº«ï¼Œè¿™ä¸ªå‚æ•°åœ¨å‡½æ•°å†…éƒ¨æˆ‘ä»¬åŒæ ·é€šè¿‡thisæŒ‡é’ˆæ¥è®¿é—®ã€‚å¯ä»¥çœ‹åˆ°é€šè¿‡è™šæ‹Ÿå†…å­˜æ®µthisï¼Œæˆ‘ä»¬ç®€åŒ–äº†å¯¹è±¡è®¿é—®æ“ä½œã€‚</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">compileDo</span>
  <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">compileSubroutineCall</span><span class="p">()</span>
  <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePop</span><span class="p">(</span><span class="s2">"temp"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">#doè¯­å¥æ€»æ˜¯è°ƒç”¨è¿”å›ç±»å‹ä¸ºvoidçš„å‡½æ•°ï¼Œæ‰€ä»¥æœ€åå¼¹å‡º(å¹¶å¿½ç•¥)è°ƒç”¨å‡½æ•°çš„è¿”å›å€¼</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">compileSubroutineCall</span>
  <span class="n">isVoid</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="n">firstSymbol</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">getIndentifier</span><span class="p">()</span>
  <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="k">if</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">symbol</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"("</span> <span class="c1">#è°ƒå†…éƒ¨æ–¹æ³•åˆ†æ”¯</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePush</span><span class="p">(</span><span class="s2">"pointer"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">#è°ƒç”¨å®ä¾‹æ–¹æ³•ï¼Œå…ˆpush this</span>
    <span class="n">paramCount</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">compileExpressionList</span><span class="p">()</span>
    <span class="n">methodName</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="vi">@className</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="n">firstSymbol</span><span class="si">}</span><span class="s2">"</span>
    <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeCall</span><span class="p">(</span><span class="n">methodName</span><span class="p">,</span> <span class="n">paramCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="k">elsif</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">symbol</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"."</span> <span class="c1">#è°ƒå¤–éƒ¨æ–¹æ³•åˆ†æ”¯</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="n">className</span> <span class="o">=</span> <span class="n">firstSymbol</span>
    <span class="n">methodName</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">getIndentifier</span><span class="p">()</span> 
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="n">symbolKind</span> <span class="o">=</span> <span class="vi">@symbolTable</span><span class="p">.</span><span class="nf">kindOf</span><span class="p">(</span><span class="n">firstSymbol</span><span class="p">)</span>
    <span class="n">symbolIndex</span> <span class="o">=</span> <span class="vi">@symbolTable</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="n">firstSymbol</span><span class="p">)</span>
    <span class="n">isInstanceMethod</span> <span class="o">=</span> <span class="n">symbolKind</span> <span class="o">!=</span> <span class="s2">"NONE"</span> <span class="o">&amp;&amp;</span> <span class="n">symbolIndex</span> <span class="o">!=</span> <span class="s2">"NONE"</span>
    <span class="k">if</span>  <span class="n">isInstanceMethod</span> <span class="c1">#è°ƒç”¨å®ä¾‹çš„æ–¹æ³•</span>
      <span class="k">if</span> <span class="n">symbolKind</span> <span class="o">==</span> <span class="s2">"field"</span>
        <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePush</span><span class="p">(</span><span class="s2">"this"</span><span class="p">,</span> <span class="n">symbolIndex</span><span class="p">)</span> <span class="c1">#push this</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="vi">@curFunctionType</span> <span class="o">==</span> <span class="s2">"method"</span> <span class="o">&amp;&amp;</span> <span class="n">symbolKind</span> <span class="o">==</span> <span class="s2">"argument"</span>
          <span class="n">symbolIndex</span> <span class="o">=</span> <span class="n">symbolIndex</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">end</span>
        <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePush</span><span class="p">(</span><span class="n">symbolKind</span><span class="p">,</span> <span class="n">symbolIndex</span><span class="p">)</span>
      <span class="k">end</span>
      <span class="n">className</span> <span class="o">=</span> <span class="vi">@symbolTable</span><span class="p">.</span><span class="nf">typeOf</span><span class="p">(</span><span class="n">firstSymbol</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">paramCount</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">compileExpressionList</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">isInstanceMethod</span>
      <span class="n">paramCount</span> <span class="o">=</span> <span class="n">paramCount</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">end</span>
    <span class="n">callName</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="n">className</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="n">methodName</span><span class="si">}</span><span class="s2">"</span>
    <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeCall</span><span class="p">(</span><span class="n">callName</span><span class="p">,</span> <span class="n">paramCount</span><span class="p">)</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="æ•°ç»„è®¿é—®">æ•°ç»„è®¿é—®</h3>

<p>å¯¹è±¡çš„è®¿é—®æˆ‘ä»¬ä½¿ç”¨äº†thisæŒ‡é’ˆï¼Œé‚£ä¹ˆæ•°ç»„çš„è®¿é—®æˆ‘ä»¬ä¼šç”¨ä¸Šæœ€åä¸€ä¸ªè™šæ‹Ÿå†…å­˜æ®µï¼šthatæŒ‡é’ˆã€‚ä¾‹å¦‚åœ¨è®¿é—®æ•°ç»„å¯¹è±¡array[index]æ—¶ï¼Œå…ˆè®¡ç®—arrayæŒ‡å‘çš„é¦–åœ°å€+indexï¼Œå¾—å‡ºçš„å€¼å°±æ˜¯è¦è®¿é—®çš„å…ƒç´ ï¼Œç„¶åæŠŠè¿™ä¸ªå€¼èµ‹å€¼ç»™thatæŒ‡é’ˆï¼Œè¿™é‡Œé¢ç”¨åˆ°äº†temp 0æ¥ä¿å­˜ä¸´æ—¶å˜é‡ï¼Œä¸ºäº†é˜²æ­¢thatæŒ‡é’ˆåœ¨ä½¿ç”¨æ—¶å†²çªã€‚thatæŒ‡é’ˆçš„å­˜åœ¨ä¹Ÿæ˜¯ä¸ºäº†ç®€åŒ–ä»£ç çš„ç»“æ„ã€‚</p>
<center><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcd3wstnv3j316p0u0q3y.jpg" width="700" /></center>
<p>å…³é”®ä»£ç å®ç°å¦‚ä¸‹ï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="n">function</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">var</span> <span class="nc">Array</span> <span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">c</span><span class="o">;</span>
    
    <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="nc">Array</span><span class="o">.</span><span class="na">new</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
    <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="nc">Array</span><span class="o">.</span><span class="na">new</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
    <span class="n">let</span> <span class="n">c</span> <span class="o">=</span> <span class="nc">Array</span><span class="o">.</span><span class="na">new</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    
    <span class="n">let</span> <span class="n">a</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
    <span class="n">let</span> <span class="n">a</span><span class="o">[</span><span class="mi">4</span><span class="o">]</span> <span class="o">=</span> <span class="mi">8</span><span class="o">;</span>
    <span class="n">let</span> <span class="n">a</span><span class="o">[</span><span class="mi">5</span><span class="o">]</span> <span class="o">=</span> <span class="mi">4</span><span class="o">;</span>
    <span class="n">let</span> <span class="n">b</span><span class="o">[</span><span class="n">a</span><span class="o">[</span><span class="mi">3</span><span class="o">]]</span> <span class="o">=</span> <span class="n">a</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="o">+</span> <span class="mi">3</span><span class="o">;</span>  <span class="c1">// b[2] = 5</span>
    <span class="n">let</span> <span class="n">a</span><span class="o">[</span><span class="n">b</span><span class="o">[</span><span class="n">a</span><span class="o">[</span><span class="mi">3</span><span class="o">]]]</span> <span class="o">=</span> <span class="n">a</span><span class="o">[</span><span class="n">a</span><span class="o">[</span><span class="mi">5</span><span class="o">]]</span> <span class="o">*</span> <span class="n">b</span><span class="o">[((</span><span class="mi">7</span> <span class="o">-</span> <span class="n">a</span><span class="o">[</span><span class="mi">3</span><span class="o">])</span> <span class="o">-</span> <span class="nc">Main</span><span class="o">.</span><span class="na">double</span><span class="o">(</span><span class="mi">2</span><span class="o">))</span> <span class="o">+</span> <span class="mi">1</span><span class="o">];</span>  <span class="c1">// a[5] = 8 * 5 = 40</span>
    <span class="n">let</span> <span class="n">c</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
    
    <span class="o">......</span>
    <span class="k">return</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">compileLet</span>
  <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="n">varName</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">getIndentifier</span><span class="p">()</span>
  <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="n">isArray</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="k">if</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">symbol</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"["</span> <span class="c1">#æ•°ç»„</span>
    <span class="n">isArray</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">compileExpression</span><span class="p">()</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">pushVarName</span><span class="p">(</span><span class="n">varName</span><span class="p">)</span>
    <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeArithmetic</span><span class="p">(</span><span class="s2">"add"</span><span class="p">)</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>    
  <span class="k">end</span>
  <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">compileExpression</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">isArray</span>                                 
    <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePop</span><span class="p">(</span><span class="s2">"temp"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>            <span class="c1">#temp0 = expression above</span>
    <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePop</span><span class="p">(</span><span class="s2">"pointer"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>         <span class="c1">#thatæŒ‡å‘æ•°ç»„</span>
    <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePush</span><span class="p">(</span><span class="s2">"temp"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePop</span><span class="p">(</span><span class="s2">"that"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="n">symbolKind</span> <span class="o">=</span> <span class="vi">@symbolTable</span><span class="p">.</span><span class="nf">kindOf</span><span class="p">(</span><span class="n">varName</span><span class="p">)</span>
    <span class="n">symbolIndex</span> <span class="o">=</span> <span class="vi">@symbolTable</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="n">varName</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">symbolKind</span> <span class="o">==</span> <span class="s2">"argument"</span> <span class="o">||</span> <span class="n">symbolKind</span> <span class="o">==</span> <span class="s2">"local"</span> <span class="o">||</span> <span class="n">symbolKind</span> <span class="o">==</span> <span class="s2">"static"</span>
      <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePop</span><span class="p">(</span><span class="n">symbolKind</span><span class="p">,</span> <span class="n">symbolIndex</span><span class="p">)</span> <span class="c1"># æŠŠexpressionçš„å€¼popåˆ°var</span>
    <span class="k">elsif</span> <span class="n">symbolKind</span> <span class="o">==</span> <span class="s2">"field"</span>
      <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePop</span><span class="p">(</span><span class="s2">"this"</span><span class="p">,</span> <span class="n">symbolIndex</span><span class="p">)</span> <span class="c1"># æŠŠexpressionçš„å€¼popåˆ°thisæ®µ</span>
    <span class="k">else</span>
      <span class="k">raise</span> <span class="s2">"ä¸èƒ½è¯†åˆ«"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">compileTerm</span>
  <span class="o">......</span>
  <span class="k">else</span> <span class="c1">#varName | varName[expression] | subroutineCall</span>
    <span class="n">firstToken</span> <span class="o">=</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">identifier</span><span class="p">()</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="n">secondToken</span> <span class="o">=</span> <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">symbol</span><span class="p">()</span>
    <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">backward</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">secondToken</span> <span class="o">!=</span> <span class="s2">"["</span> <span class="o">&amp;&amp;</span> <span class="n">secondToken</span> <span class="o">!=</span> <span class="s2">"("</span> <span class="o">&amp;&amp;</span> <span class="n">secondToken</span> <span class="o">!=</span> <span class="s2">"."</span> <span class="c1">#varName</span>
      <span class="n">varName</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">getIndentifier</span><span class="p">()</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">pushVarName</span><span class="p">(</span><span class="n">varName</span><span class="p">)</span>
      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="k">elsif</span> <span class="n">secondToken</span> <span class="o">==</span> <span class="s2">"["</span> <span class="c1">#varName[expression]</span>
      <span class="n">varName</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">getIndentifier</span><span class="p">()</span>
      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">compileExpression</span><span class="p">()</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">pushVarName</span><span class="p">(</span><span class="n">varName</span><span class="p">)</span>
      <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writeArithmetic</span><span class="p">(</span><span class="s2">"add"</span><span class="p">)</span>
      <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePop</span><span class="p">(</span><span class="s2">"pointer"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">#ä¿®æ”¹That</span>
      <span class="vi">@vmWriter</span><span class="p">.</span><span class="nf">writePush</span><span class="p">(</span><span class="s2">"that"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="vi">@tokenizer</span><span class="p">.</span><span class="nf">advance</span><span class="p">()</span>
    <span class="k">elsif</span> 
      <span class="o">......</span> 
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="æ€»ç»“">æ€»ç»“</h3>

<p>æ—¥å¸¸å·¥ä½œä¸­ï¼Œç»å¤§å¤šæ•°ç¨‹åºå‘˜éƒ½ä¸ä¼šå»ç¼–å†™ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œæˆ‘ä»¬å¯¹äºç¼–è¯‘å™¨çš„å­¦ä¹ å’Œäº†è§£å¯èƒ½æ›´å¤šçš„æ¥è‡ªå¯¹ä¸€äº›æ•™æå’Œèµ„æ–™æµ…å°è¾„æ­¢åœ°é˜…è¯»ï¼Œåªæ˜¯å½¢æˆäº†ä¸€ä¸ªæ¨¡ç³Šçš„æ¦‚å¿µï¼Œç”šè‡³è‡ªå·±éƒ½ä¼šæ€€ç–‘è‡ªå·±å¯¹å…¶ç†è§£çš„æ­£ç¡®æ€§ã€‚è™½ç„¶æ¯”èµ·åŠ¨è¾„ç™¾ä¸‡è¡Œä»£ç çš„å·¥ä¸šçº§ç¼–è¯‘å™¨ï¼ŒJackç¼–è¯‘å™¨å®åœ¨æ˜¯å¤ªè¿‡ç®€å•ï¼Œä½†æˆ‘ä»¬ä»å¯ä»¥ä»äº²è‡ªå®ç°å®ƒçš„è¿‡ç¨‹ä¸­çœŸæ­£åœ°çª¥æ¢åˆ°ç¼–è¯‘å™¨å·¥ä½œçš„åŸºæœ¬åŸç†ã€‚</p>

<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬ä»0åˆ°1æ„å»ºè®¡ç®—æœºç³»åˆ—çš„æ–‡ç« å°±è¦æ¥è¿‘å°¾å£°äº†ï¼Œä¸‹ä¸€ç¯‡æˆ‘ä»¬ä¼šå®ç°ä¸€ä¸ªæœ€ç®€å•çš„æ“ä½œç³»ç»Ÿï¼Œæ”¯æŒé«˜çº§æ•°å­¦è¿ç®—ã€å†…å­˜åˆ†é…ã€æ•°ç»„æ“ä½œã€å­—ç¬¦ä¸²æ“ä½œã€è¾“å…¥è¾“å‡ºç­‰èƒ½åŠ›ã€‚</p>

<p>æœ¬ç¯‡å®Œæ•´å®ç°æ”¾åœ¨äº†:<a href="https://github.com/guosainpu/Nand2Tetris">github</a></p>
:ET