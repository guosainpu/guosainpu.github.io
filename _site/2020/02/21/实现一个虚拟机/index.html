<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="关于程序与设计、黑客与画家 | 黄玄，Web & Mobile Lover，Software Engineer，UX Designer | 这里是 @Hux黄玄 的个人博客，与你一起发现更大的世界。">
    <meta name="keywords"  content="黄玄, Hux黄玄, Hux, 鬼栈, huxpro, @huxpro, 黄玄的博客, Hux Blog, 博客, 个人网站, 互联网, Web, JavaScript, 前端, 设计">
    <meta name="theme-color" content="#000000">
    
    <!-- Open Graph -->
    <meta property="og:title" content="从0到1构建计算机(7/12)--实现一个虚拟机 - 一只草履虫">
    
    <meta property="og:type" content="article">
    <meta property="og:description" content="计算机工作的本质就是对内存中的数据进行操作，因此只需要具备两种能力即可：(1)对内存的读和写；(2)用对数据进行算数逻辑运算。此外，支持指令跳转能大大提高计算机的可编程能力。直观上看，Hack具备了以上三项能力，我们上一篇也举例了如何实现1+2+…+100。但Hack和我们常用的CPU具备几百条指令集的能力还相去甚远，例如支持四则运算，对栈的操作，指针寄存器的使用，支持函数调用，处理入参和回...">
    
    <meta property="article:published_time" content="2020-02-21T00:00:00Z">
    
    
    <meta property="article:author" content="guosai">
    
    
    <meta property="article:tag" content="计算机基础">
    
    <meta property="article:tag" content="从0到1构建计算机">
    
    <meta property="article:tag" content="虚拟机">
    
    
    <meta property="og:image" content="http://localhost:4000/img/avatar-hux-ny.jpg">
    <meta property="og:url" content="http://localhost:4000/2020/02/21/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E8%99%9A%E6%8B%9F%E6%9C%BA/">
    <meta property="og:site_name" content="一只草履虫">
    
    <title>从0到1构建计算机(7/12)--实现一个虚拟机 - 一只草履虫</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="http://localhost:4000/2020/02/21/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E8%99%9A%E6%8B%9F%E6%9C%BA/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->

    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">一只草履虫</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div id="huxblog_navbar">
                <div class="navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="/">Home</a>
                        </li>
                        
                        
                        
                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                        
                        
                        <li>
                            <a href="/archive/">Archive</a>
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <li class="search-icon">
                            <a href="javascript:void(0)">
                                <i class="fa fa-search"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <script>
        // Drop Bootstarp low-performance Navbar
        // Use customize navbar with high-quality material design animation
        // in high-perf jank-free CSS3 implementation
        var $body = document.body;
        var $toggle = document.querySelector('.navbar-toggle');
        var $navbar = document.querySelector('#huxblog_navbar');
        var $collapse = document.querySelector('.navbar-collapse');

        var __HuxNav__ = {
            close: function () {
                $navbar.className = " ";
                // wait until animation end.
                setTimeout(function () {
                    // prevent frequently toggle
                    if ($navbar.className.indexOf('in') < 0) {
                        $collapse.style.height = "0px"
                    }
                }, 400)
            },
            open: function () {
                $collapse.style.height = "auto"
                $navbar.className += " in";
            }
        }

        // Bind Event
        $toggle.addEventListener('click', function (e) {
            if ($navbar.className.indexOf('in') > 0) {
                __HuxNav__.close()
            } else {
                __HuxNav__.open()
            }
        })

        /**
         * Since Fastclick is used to delegate 'touchstart' globally
         * to hack 300ms delay in iOS by performing a fake 'click',
         * Using 'e.stopPropagation' to stop 'touchstart' event from 
         * $toggle/$collapse will break global delegation.
         * 
         * Instead, we use a 'e.target' filter to prevent handler
         * added to document close HuxNav.  
         *
         * Also, we use 'click' instead of 'touchstart' as compromise
         */
        document.addEventListener('click', function (e) {
            if (e.target == $toggle) return;
            if (e.target.className == 'icon-bar') return;
            __HuxNav__.close();
        })
    </script>
    <!-- Search -->
<div class="search-page">
  <div class="search-icon-close-container">
    <span class="search-icon-close">
      <i class="fa fa-chevron-down"></i>
    </span>
  </div>
  <div class="search-main container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <form></form>
        <input type="text" id="search-input" placeholder="$ grep...">
        </form>
        <div id="search-results" class="mini-post-list"></div>
      </div>
    </div>
  </div>
</div>

    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/home-bg.jpg" width="0" height="0"> -->

<!-- Post Header -->



<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/home-bg.jpg');
        background: ;
    }

    
</style>

<header class="intro-header" >

    <div class="header-mask"></div>
    
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/archive/?tag=%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80" title="计算机基础">计算机基础</a>
                        
                        <a class="tag" href="/archive/?tag=%E4%BB%8E0%E5%88%B01%E6%9E%84%E5%BB%BA%E8%AE%A1%E7%AE%97%E6%9C%BA" title="从0到1构建计算机">从0到1构建计算机</a>
                        
                        <a class="tag" href="/archive/?tag=%E8%99%9A%E6%8B%9F%E6%9C%BA" title="虚拟机">虚拟机</a>
                        
                    </div>
                    <h1>从0到1构建计算机(7/12)--实现一个虚拟机</h1>
                    
                    <h2 class="subheading"></h2>
                    <span class="meta">Posted by guosai on February 21, 2020</span>
                </div>
            </div>
        </div>
    </div>
</header>






<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                

				<p>计算机工作的本质就是对内存中的数据进行操作，因此只需要具备两种能力即可：(1)对内存的读和写；(2)用对数据进行算数逻辑运算。此外，支持指令跳转能大大提高计算机的可编程能力。直观上看，Hack具备了以上三项能力，我们上一篇也举例了如何实现1+2+…+100。但Hack和我们常用的CPU具备几百条指令集的能力还相去甚远，例如支持四则运算，对栈的操作，指针寄存器的使用，支持函数调用，处理入参和回参等。如何解决这些问题呢？我们需要在简单的Hack之上，再构建一个更加复杂，能力更强的虚拟计算机，这个虚拟机向上提供了一套新的操作指令，即虚拟机的字节码（在Hack中这套字节码更接近我们常用的CPU指令集），其中每条虚拟机指令都是通过封装汇编层一系列的汇编指令来实现的，在本篇中我们会再一次看到在计算机科学中“封装”的强大力量。</p>

<p>虚拟机可能有多种解释，我们要实现的虚拟机是一种程序虚拟机（类似于Java虚拟机），主要是用来支持运行平台无关的计算机程序。其他概念的虚拟机还有系统虚拟机，完全虚拟一个操作系统出来，例如VMWare，iOS模拟器等。</p>

<h3 id="一个c程序">一个C程序</h3>
<p>我们来写一个简单的C程序：add。然后思考一下，如何把这段程序翻译成Hack上的汇编语言呢？如果仅仅是翻译这一个程序，貌似是可行的，但如果想要直接翻译一个复杂的C程序则是相当困难的，所以我们需要对Hack再进行一些扩展。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">result</span><span class="p">;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>我们把上面的C程序在Mac上编译成可执行文件，然后看一下这个它在x86_64架构下的汇编代码。我们看到它的汇编代码并不复杂，它被编译成了两个函数，然后通过一些的push, pop, mov, add, call, return等指令完成。这些指令就是Hack的虚拟机需要参考和实现的。从这一点上来看，Hack的虚拟机更接近我们常用的CPU。</p>
<center><img src="https://tva1.sinaimg.cn/large/0082zybply1gc44fal8vmj30zj0u0tbs.jpg" width="700" /></center>

<h3 id="stack">Stack</h3>

<p>无论是x86_64架构下的汇编指令，还是我们需要实现的Hack虚拟机，都需要支持四种基本操作：<strong>算数逻辑操作，内存访问操作，程序流程控制，函数调用</strong>。想要方便的实现这些操作，我们需要借助一种常用的数据结构：堆栈（stack）。<strong>经证明，通过堆栈操作，能够实现任何数学或逻辑表达式；任何程序，无论用什么语言编写，都能够被翻译成等价的堆栈机语言</strong>。</p>

<h3 id="push--pop">Push &amp; Pop</h3>

<p>既然是栈的使用，那肯定少不了Push和Pop操作。SP（Stack Pointer）指针是这两项操作的关键，<strong>SP指针实时地指向栈顶</strong>：Push操作把一个数（可以是内存中的某个数）压入栈顶，然后SP加1（如果栈从上向下生长就减1）；Pop操作把栈顶的数弹出（可以弹出到某个内存地址），然后SP减1。</p>
<center><img src="https://tva1.sinaimg.cn/large/0082zybply1gc49n0apfxj31a60oqdgh.jpg" width="700" /></center>

<h3 id="内存划分">内存划分</h3>

<p>内存划分是Hack虚拟机中另一个重要主题。Hack的内存由32K的16位字组成，其中前16K是通用内存，后16K是I/O设备的内存映像。</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>       0-15：16个虚拟寄存器(Hack寄存器不够用了)
     16-255：静态变量区
   256-2047：栈
 2048-16383：堆
16384-24575：I/O内存映像
</pre></td></tr></tbody></table></code></pre></div></div>
<p>0-15位内存和寄存器的映射关系如下：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>"SP"=&gt;"000000000000000", "LCL"=&gt;"000000000000001", "ARG"=&gt;"000000000000010", "THIS"=&gt;"000000000000011", "THAT"=&gt;"000000000000100", 
"R0"=&gt;"000000000000000", "R1"=&gt;"000000000000001", "R2"=&gt;"000000000000010", "R3"=&gt;"000000000000011", 
"R4"=&gt;"000000000000100", "R5"=&gt;"000000000000101", "R6"=&gt;"000000000000110", "R7"=&gt;"000000000000111", 
"R8"=&gt;"000000000001000", "R9"=&gt;"000000000001001", "R10"=&gt;"000000000001010", "R11"=&gt;"000000000001011", 
"R12"=&gt;"000000000001100", "R13"=&gt;"000000000001101", "R14"=&gt;"000000000001110", "R15"=&gt;"000000000001111",
"SCREEN"=&gt;"100000000000000", "KBD"=&gt;"110000000000000"
</pre></td></tr></tbody></table></code></pre></div></div>

<p>虚拟机操纵8个独立的<strong>虚拟内存段</strong>。在这里虚拟内存是一个很重要的技巧，内存段都有各自的用途，在程序执行过程中，每个函数都可以通过固定的几个指针（R0-R15）来访问这些内存段，看上去每个内存段都是它们独享的（有些是共享的），而不必关心他们的物理地址在哪里，是否会和其他函数冲突等。这本质上也是一种封装，这种封装向上提供一种标准的内存访问方式，向下了实现虚拟内存和物理内存的映射和管理（类似于操作系统中进程地址空间的映射）。这大大降低了虚拟机使用者的难度，把复杂的工作交给了虚拟机本身。</p>
<center><img src="https://tva1.sinaimg.cn/large/0082zybply1gc4bnrpe9fj30wf0u0djx.jpg" width="700" /></center>

<p>我们来看一下代码和内存段的关系。一个类被编译成一个.VM文件，其中包含了若干个函数实现f1, f2, f3。temp和const段是进程级别共享的；static段是类级别共享的；argument、local、this、that、pointer是函数级别的独享的，每个函数都有自己的这5个内存段，但每个函数访问它们的方式却是一致的（即通过R1-R5指针）</p>
<center><img src="https://tva1.sinaimg.cn/large/0082zybply1gc4c6ry36pj30zq0u0q44.jpg" width="700" /></center>

<h3 id="内存访问命令">内存访问命令</h3>

<p>所有的内存段访问都通过2条命令实现：</p>
<ul>
  <li>push segement index 		将segement[index]的值压入堆栈</li>
  <li>pop  segement index 		将栈顶元素弹出，然后存入segement[index]</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>push locol 0 		#把locol段第一个位置的值压入堆栈
push constant 123 	#把常数123压入堆栈
pop static 1 		#把栈顶元素弹出，存入static的第二个位置
</pre></td></tr></tbody></table></code></pre></div></div>
<center><img src="https://tva1.sinaimg.cn/large/0082zybply1gc51adti2gj31000gumxq.jpg" width="700" /></center>

<h4 id="实现">实现</h4>

<p>push和pop指令的作用就是在栈顶内存和段内存之间互相搬运数值。SP指针用于标识栈顶内存，segement基地址+偏移量用于标识段内存，然后通过一系列寄存器和内存操作（利用A寄存器定位内存地址，D寄存器暂存数值等操作）实现这两个命令。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">writePushPop</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">segment</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>			<span class="c1">#实现push, pop命令</span>
	<span class="n">asm_cmd</span> <span class="o">=</span> <span class="s1">''</span>
	<span class="n">segment</span> <span class="o">=</span> <span class="vi">@table</span><span class="p">[</span><span class="s2">"</span><span class="si">#{</span><span class="n">segment</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span>
	<span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s1">'C_PUSH'</span> <span class="o">&amp;&amp;</span> <span class="n">segment</span> <span class="o">==</span><span class="s1">'constant'</span> 		<span class="c1">#push const</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">pushConstant</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
	<span class="k">elsif</span> <span class="n">command</span> <span class="o">==</span> <span class="s1">'C_PUSH'</span> 							
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">passArgsAddressToA</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> 	<span class="c1">#A=段地址+偏移地址</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"D=M"</span> <span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 			<span class="c1">#段内存的值存到D</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">pushDtoStack</span><span class="p">()</span>			<span class="c1">#push D到栈顶，sp+1</span>
	<span class="k">elsif</span> <span class="n">command</span> <span class="o">==</span> <span class="s1">'C_POP'</span> 							
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">passArgsAddressToA</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> 	<span class="c1">#A=段地址+偏移地址</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">getStackTopToD</span><span class="p">()</span>			<span class="c1">#栈顶的值存到D</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"M=D"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 			<span class="c1">#pop D到段内存</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"@SP"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"M=M-1"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 			<span class="c1">#sp减1</span>
	<span class="k">end</span>

	<span class="k">if</span> <span class="n">asm_cmd</span><span class="p">.</span><span class="nf">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
		<span class="vi">@sam_file</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">asm_cmd</span><span class="p">)</span>
	<span class="k">end</span>	
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">pushConstant</span><span class="p">(</span><span class="n">const</span><span class="p">)</span> 		<span class="c1">#实现简单的push const</span>
	<span class="n">asm_cmd</span> <span class="o">=</span> <span class="s2">"@</span><span class="si">#{</span><span class="n">const</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"D=A"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">pushDtoStack</span><span class="p">()</span>
	<span class="k">return</span> <span class="n">asm_cmd</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">pushDtoStack</span>			<span class="c1">#把D寄存器的值push到栈顶，sp+1</span>
	<span class="n">asm_cmd</span> <span class="o">=</span> <span class="s2">"@SP"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"A=M"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"M=D"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"@SP"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"M=M+1"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="k">return</span> <span class="n">asm_cmd</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">getStackTopToD</span>			<span class="c1">#把栈顶的值存到D寄存器，sp不变</span>
	<span class="n">asm_cmd</span> <span class="o">=</span> <span class="s2">"D=A"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"@R13"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"M=D"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 	<span class="c1">#先把A的值暂存到R13，后面在还原A寄存器（保存现场）</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"@SP"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"A=M-1"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"D=M"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 	<span class="c1">#取出值放入D</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"@R13"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"A=M"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 	<span class="c1">#恢复A</span>
	<span class="k">return</span> <span class="n">asm_cmd</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">passArgsAddressToA</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>		<span class="c1">#把内存地址存到A</span>
	<span class="n">asm_cmd</span> <span class="o">=</span> <span class="s1">''</span>
	<span class="k">if</span>  <span class="n">segment</span> <span class="o">==</span> <span class="s2">"static"</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"@</span><span class="si">#{</span><span class="vi">@source_file_name</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="n">index</span><span class="si">}</span><span class="s2">"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 	<span class="c1">#文件名+index作为static的符号</span>
		<span class="k">return</span> <span class="n">asm_cmd</span>
	<span class="k">end</span>

	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"@</span><span class="si">#{</span><span class="n">index</span><span class="si">}</span><span class="s2">"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"D=A"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 		<span class="c1">#D=index偏移量</span>
	<span class="k">if</span>  <span class="n">segment</span> <span class="o">==</span> <span class="s2">"temp"</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"@R5"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"A=A+D"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 	<span class="c1">#A=temp地址+偏移量</span>
		<span class="nb">puts</span> <span class="s2">"执行了</span><span class="si">#{</span><span class="n">segment</span><span class="si">}</span><span class="s2">"</span>
	<span class="k">elsif</span> <span class="n">segment</span> <span class="o">==</span> <span class="s2">"pointer"</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"@THIS"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"A=A+D"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 	<span class="c1">#A=THIS+偏移量</span>
	<span class="k">else</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"@</span><span class="si">#{</span><span class="n">segment</span><span class="si">}</span><span class="s2">"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"A=M+D"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 	<span class="c1">#A=段内存指针指向的段基地址+偏移量</span>
	<span class="k">end</span>
	<span class="k">return</span> <span class="n">asm_cmd</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="算数逻辑运算命令">算数逻辑运算命令</h3>

<p>我们还需要实现若干一元或二元的算数&amp;逻辑运算命令，包括二元加减法，两个数的比较，与或非，取反操作。在这里我们没有实现浮点数操作，也没有实现乘除法（后面我们会在软件的层面实现乘除法）。</p>
<center><img src="https://tva1.sinaimg.cn/large/0082zybply1gc56ao98qxj30w00k2js2.jpg" width="600" /></center>

<p>我们以下面的伪命令为例，看下如何利用栈来进行算数逻辑运算。运算x+y时，是一种以后缀表达式形式的运算：先把x入栈，sp+1；然后把y入栈，sp+1，然后计算加法，把结果值存入当前x的位置，sp-2。一元运算则更简单，运算-x时：先把x入栈，sp=1，然后取反，把结果值存入当前x的位置，sp-1。</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>// d=(2-x)*(y+5)
push 2
push x
sub
push y
push 5
add
mult
pop d
</pre></td></tr></tbody></table></code></pre></div></div>
<center><img src="https://tva1.sinaimg.cn/large/0082zybply1gc56iuqmzsj319g0qu3zg.jpg" width="700" /></center>

<h4 id="实现-1">实现</h4>

<p>在实现上主要思路是利用D寄存器配合SP指针，例如x+y：把y赋值给D，然后SP指向x，然后D=D+M，最后把D再赋值给SP指向的内存。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">arithmetic</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
	<span class="n">asm_cmd</span> <span class="o">=</span> <span class="s2">""</span>
	<span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">'add'</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">passYtoD</span><span class="p">()</span>		<span class="c1">#D=y</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"A=A-1"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"D=D+M"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 	<span class="c1">#D=x+y</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"M=D"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">resetSP</span><span class="p">()</span>		<span class="c1">#sp重置</span>
	<span class="k">elsif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">'sub'</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">passYtoD</span><span class="p">()</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"A=A-1"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"D=M-D"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 	<span class="c1">#D=x-y</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"M=D"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">resetSP</span><span class="p">()</span>
	<span class="k">elsif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">'neg'</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">passYtoD</span><span class="p">()</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"M=-D"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 	<span class="c1">#M=-D</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">resetSP</span><span class="p">()</span>
	<span class="k">elsif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">'eq'</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">passYtoD</span><span class="p">()</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">compare</span><span class="p">(</span><span class="s2">"JEQ"</span><span class="p">)</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">resetSP</span><span class="p">()</span>
	<span class="k">elsif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">'gt'</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">passYtoD</span><span class="p">()</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">compare</span><span class="p">(</span><span class="s2">"JGT"</span><span class="p">)</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">resetSP</span><span class="p">()</span>
	<span class="k">elsif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">'lt'</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">passYtoD</span><span class="p">()</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">compare</span><span class="p">(</span><span class="s2">"JLT"</span><span class="p">)</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">resetSP</span><span class="p">()</span>
	<span class="k">elsif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">'and'</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">passYtoD</span><span class="p">()</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"A=A-1"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"D=D&amp;M"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 	<span class="c1">#D=x&amp;y</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"M=D"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">resetSP</span><span class="p">()</span>
	<span class="k">elsif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">'or'</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">passYtoD</span><span class="p">()</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"A=A-1"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"D=D|M"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 	<span class="c1">#D=x|y</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"M=D"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">resetSP</span><span class="p">()</span>
	<span class="k">elsif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">'not'</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">passYtoD</span><span class="p">()</span>
		<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"M=!D"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="k">end</span>
	<span class="k">return</span> <span class="n">asm_cmd</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">passYtoD</span>				<span class="c1">#y赋值给D寄存器</span>
	<span class="n">asm_cmd</span> <span class="o">=</span> <span class="s2">"@SP"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"A=M"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"A=A-1"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>	<span class="c1">#sp-1后指向y</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"D=M"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 	<span class="c1">#D=y</span>
	<span class="k">return</span> <span class="n">asm_cmd</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">resetSP</span>
	<span class="n">asm_cmd</span> <span class="o">=</span> <span class="s2">"D=A"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"@SP"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"M=D+1"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 	<span class="c1">#SP指针重置</span>
	<span class="k">return</span> <span class="n">asm_cmd</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> 			<span class="c1">#xy大小比较。</span>
	<span class="n">asm_cmd</span> <span class="o">=</span> <span class="s2">"A=A-1"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"D=M-D"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 	<span class="c1">#D=x-y</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"@branchLabel_</span><span class="si">#{</span><span class="vi">@branchIndex</span><span class="si">}</span><span class="s2">"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"D;</span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"D=0"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 	<span class="c1">#0(0x0000)代表false</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"@mergeLabel_</span><span class="si">#{</span><span class="vi">@mergeIndex</span><span class="si">}</span><span class="s2">"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"0;JMP"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"(branchLabel_</span><span class="si">#{</span><span class="vi">@branchIndex</span><span class="si">}</span><span class="s2">)"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"D=-1"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 	<span class="c1">#-1(0xFFFF)代表true</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"(mergeLabel_</span><span class="si">#{</span><span class="vi">@mergeIndex</span><span class="si">}</span><span class="s2">)"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"@SP"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"A=M-1"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"A=A-1"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"M=D"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="vi">@branchIndex</span> <span class="o">=</span> <span class="vi">@branchIndex</span> <span class="o">+</span> <span class="mi">1</span>
	<span class="vi">@mergeIndex</span> <span class="o">=</span> <span class="vi">@mergeIndex</span> <span class="o">+</span> <span class="mi">1</span>
	<span class="k">return</span> <span class="n">asm_cmd</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="程序流程控制命令">程序流程控制命令</h3>

<p>计算机默认的执行顺序是线性的，程序流程控制这一节我们需要实现跳转功能和分支功能，即以下三个指令：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>	label：用于标识指令地址
   goto label：无条件跳转到指令地址
if_goto label：先弹出并判断栈顶值，非0时跳转，否则线性执行
</pre></td></tr></tbody></table></code></pre></div></div>
<center><img src="https://tva1.sinaimg.cn/large/0082zybply1gc69u6g16cj30vo0pywfi.jpg" width="500" /></center>

<h4 id="实现-2">实现</h4>
<p>这三条指令的实现非常简单。原因是这里label扮演了重要的功能，由于下层的汇编器支持把label识别成指令地址，所以这里我们就不必再关心需要跳转的具体地址，省去了很多工作。这里我们看到只要下层设计封装的好，就会大大降低上层的实现难度。</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">writeLabel</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
	<span class="n">asm_cmd</span> <span class="o">=</span> <span class="s2">"(</span><span class="si">#{</span><span class="n">label</span><span class="si">}</span><span class="s2">)"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="vi">@sam_file</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">asm_cmd</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">writeGoto</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
	<span class="n">asm_cmd</span> <span class="o">=</span> <span class="s2">"@</span><span class="si">#{</span><span class="n">label</span><span class="si">}</span><span class="s2">"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"0;JMP"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>	<span class="c1">#无条件跳转</span>
	<span class="vi">@sam_file</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">asm_cmd</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">writeIf</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
	<span class="n">asm_cmd</span> <span class="o">=</span> <span class="s2">"@SP"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"A=M"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"A=A-1"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"D=M"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>		<span class="c1">#栈顶值存到D</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"@SP"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"M=M-1"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>   	<span class="c1">#指针减1</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"@</span><span class="si">#{</span><span class="n">label</span><span class="si">}</span><span class="s2">"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"D;JNE"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>	<span class="c1">#D非0时跳转</span>
	<span class="vi">@sam_file</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">asm_cmd</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="函数调用命令">函数调用命令</h3>

<p>函数调用是Hack虚拟机实现最复杂的一节。程序的执行过程就是一系列函数的调用过程，每个函数执行若干指令，操作函数中的参数变量、本地变量、静态变量三种变量。如果程序只有一个函数，那么这个工作并不复杂，因为参数变量、本地变量、静态变量都是静态的，提前分配好的，直接去使用就行了；但是如果程序是由多个函数组成的，那么这些变量在栈上就是动态的（参数变量、本地变量是动态的，静态变量还是静态的），它们的个数，分配的位置都是在动态变化的，处理起来就非常复杂。Hack虚拟机中函数调用部分的任务就是<strong>把这种动态再转变成静态</strong>：当函数被调用时，为它构建一个私有空间（frame），把它封闭在一个“与世隔绝的自我世界”（该世界只包括已经初始化的参数变量、本地变量和一个空的栈空间），然后该函数在这个私有空间内直接自己的命令。从该函数的角度来看，它不感知其他函数的存在，就好像程序只有一个函数一样，又变成了静态。</p>
<center><img src="https://tva1.sinaimg.cn/large/0082zybply1gc6ahg2sl5j31540cm74h.jpg" width="800" /></center>

<p>这一节我们需要实现以下3个指令：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>function f n：下面是一段函数名为f的代码，该函数有n个参数
    call f m：调用函数f，且调用前已将m个参数压入栈
      return：返回到调用者
</pre></td></tr></tbody></table></code></pre></div></div>

<p>函数的调用也是通过栈实现的，调用一个函数的时候，虚拟机为函数分配一块新的内存（frame），函数结束时，则回收这块内存。函数调用每加深一层，frame增长一块，每return一层，frame缩减一块，因此无限递归的函数会消耗无限的frame，导致栈内存溢出。</p>
<center><img src="https://tva1.sinaimg.cn/large/0082zybply1gc6dpovpr7j31100nojss.jpg" width="700" /></center>

<p>一个函数的调用和返回过程大致如下如下：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>1.调用函数将参数传递给被调用函数
2.保存调用函数的当前状态
3.跳转至被调用函数
4.为被调用函数分配局部变量空间并初始化
5.执行被调用函数指令序列
6.被调用函数将回参传递给调用函数
7.恢复调用函数的状态
8.回收被调用函数使用的内存空间
9.返回到之前调用函数的下一条指令执行
</pre></td></tr></tbody></table></code></pre></div></div>

<p>在函数调用时，栈上的内存使用和寄存器状态如下图。调用者在把函数入参push到栈上后，argument指针指向第一个参数；然后把函数的返回指令地址入栈；然后保存调用者的local、argument、this、that指针；然后根据被调用者局部变量数量为其分配内存空间，并把Local指针指向第一个局部变量；最后把SP指针指向栈顶，栈顶后面的内存空间都是被调用者的工作区。</p>
<center><img src="https://tva1.sinaimg.cn/large/0082zybply1gc6e1ow0z0j30sm15e0tn.jpg" width="500" /></center>

<p>被调用者执行完毕后，把返回值pop到第一个入参的位置（如果返回类型为void，就再丢弃这个返回值）；恢复调用者的各种寄存器指针；然后通过重置SP指针来回收被调用者的内存（并没有修改被调用者frame内存的数据，只是重置了栈顶的位置，后面它们将会被新的函数覆盖）。</p>
<center><img src="https://tva1.sinaimg.cn/large/0082zybply1gc6e1rab8xj31tq0su76b.jpg" width="1000" /></center>

<h4 id="实现-3">实现</h4>
<h5 id="call指令">call指令</h5>

<p>实现call指令，首先需要push调用者的返回地址，返回地址用“符号名+index”的方式标识，index的目的是防止返回地址重名，每翻译一次call指令后index需要+1；然后保存几个寄存器的状态；然后更新ARG和LCL，其中ARG=SP-n-5（参考上面的内存分布图），LCL = SP；最后执行goto跳转指令。因为调用函数return后还要返回goto指令的下一条指令标继续执行，所以需要在最后补充一个返回地址label。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>call f n 伪代码
--------------------
push return-address 	//返回地址入栈
push LCL 		//保存寄存器指针
push ARG
push THIS
push THAT
ARG = SP-n-5 		//重置ARG，第一个入参的位置是当前SP指针减n再减5
LCL = SP 		//重置LCL，第一个局部变量的位置是当前SP的位置
goto f 			//跳转到f
(return-address) 	//label标识，return后返回这里执行
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">writeCall</span><span class="p">(</span><span class="n">functionName</span><span class="p">,</span> <span class="n">numArgs</span><span class="p">)</span>
	<span class="n">writePushPop</span><span class="p">(</span><span class="s2">"C_PUSH"</span><span class="p">,</span> <span class="s2">"constant"</span><span class="p">,</span> <span class="s2">"callLabel</span><span class="si">#{</span><span class="vi">@callIndex</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
	<span class="n">saveSegment</span><span class="p">(</span><span class="s2">"LCL"</span><span class="p">)</span>
	<span class="n">saveSegment</span><span class="p">(</span><span class="s2">"ARG"</span><span class="p">)</span>
	<span class="n">saveSegment</span><span class="p">(</span><span class="s2">"THIS"</span><span class="p">)</span>
	<span class="n">saveSegment</span><span class="p">(</span><span class="s2">"THAT"</span><span class="p">)</span>
	<span class="n">resetARG</span><span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="n">numArgs</span><span class="p">.</span><span class="nf">to_i</span><span class="p">)</span>
	<span class="n">resetLCL</span><span class="p">()</span>
	<span class="n">callJump</span><span class="p">(</span><span class="n">functionName</span><span class="p">,</span> <span class="s2">"callLabel</span><span class="si">#{</span><span class="vi">@callIndex</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
	<span class="vi">@callIndex</span> <span class="o">=</span> <span class="vi">@callIndex</span> <span class="o">+</span> <span class="mi">1</span>
<span class="k">end</span>

<span class="c1"># 保存寄存器的值</span>
<span class="k">def</span> <span class="nf">saveSegment</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span> 	
	<span class="n">asm_cmd</span> <span class="o">=</span> <span class="s2">"@</span><span class="si">#{</span><span class="n">segment</span><span class="si">}</span><span class="s2">"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"D=M"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="n">pushDtoStack</span><span class="p">()</span>
	<span class="vi">@sam_file</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">asm_cmd</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># ARG设置为SP指针向前移动step步</span>
<span class="k">def</span> <span class="nf">resetARG</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span> 		
	<span class="n">asm_cmd</span> <span class="o">=</span> <span class="s2">"@SP"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"D=M"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"@</span><span class="si">#{</span><span class="n">steps</span><span class="si">}</span><span class="s2">"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"D=D-A"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"@ARG"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"M=D"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="vi">@sam_file</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">asm_cmd</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># 重置LCL，第一个局部变量的位置是当前SP的位置</span>
<span class="k">def</span> <span class="nf">resetLCL</span><span class="p">()</span> 			
	<span class="n">asm_cmd</span> <span class="o">=</span> <span class="s2">"@SP"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"D=M"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"@LCL"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"M=D"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 
	<span class="vi">@sam_file</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">asm_cmd</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># 跳转执行</span>
<span class="k">def</span> <span class="nf">callJump</span><span class="p">(</span><span class="n">functionName</span><span class="p">,</span> <span class="n">returnLabel</span><span class="p">)</span> 	
	<span class="n">asm_cmd</span> <span class="o">=</span> <span class="s2">"@</span><span class="si">#{</span><span class="n">functionName</span><span class="si">}</span><span class="s2">"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"0;JMP"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"(</span><span class="si">#{</span><span class="n">returnLabel</span><span class="si">}</span><span class="s2">)"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="vi">@sam_file</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">asm_cmd</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h5 id="function指令">function指令</h5>

<p>function f m 指令比较简单。m 代表函数 f 中有 m 个局部变量，所以只需要连续push m 次0即可：开辟了 m 个内存空间，并将其初始化为0（我们日常使用的高级语言中，不同类型的变量占的字节数可能不同。Hack进行了简化，所有基本类型的变量都占用一个字的内存）。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">writeFunction</span><span class="p">(</span><span class="n">funtionName</span><span class="p">,</span> <span class="n">numArgs</span><span class="p">)</span>
	<span class="n">asm_cmd</span> <span class="o">=</span> <span class="s2">"(</span><span class="si">#{</span><span class="n">funtionName</span><span class="si">}</span><span class="s2">)"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="c1">#首先用（funtionName）来标识函数地址</span>
	<span class="vi">@sam_file</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">asm_cmd</span><span class="p">)</span>
	<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">numArgs</span><span class="p">.</span><span class="nf">to_i</span>
		<span class="n">writePushPop</span><span class="p">(</span><span class="s2">"C_PUSH"</span><span class="p">,</span> <span class="s2">"constant"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
	<span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h5 id="return指令">return指令</h5>

<p>return指令首先需要把返回值pop到argument 0，即调用者的栈顶；然后重置一系列寄存器指针；最后跳转到返回地址。这里比较复杂的地方是如何安排各个数值的恢复顺序，因为顺序不当可能导致一些值被破坏。例如途中LCL被恢复了，导致最后取不到return的地址，我在这里的解决方案是先把return地址寄存到一个通用寄存器，后面再取出来。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>return 伪代码
--------------------
pop argument 0 	//pop返回值到argument 0
SP = ARG + 1 	//重置SP指针
restore THAT 	//恢复寄存器指针
restore THIS
restore ARG
restore LCL
goto RET 	//跳转到返回地址
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">writeReturn</span>
	<span class="n">saveReturnAddress</span><span class="p">()</span>
	<span class="n">writePushPop</span><span class="p">(</span><span class="s2">"C_POP"</span><span class="p">,</span> <span class="s2">"argument"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">)</span>
	<span class="n">restoreSP</span><span class="p">()</span>
	<span class="n">restoreSegement</span><span class="p">(</span><span class="s2">"THAT"</span><span class="p">)</span>
	<span class="n">restoreSegement</span><span class="p">(</span><span class="s2">"THIS"</span><span class="p">)</span>
	<span class="n">restoreSegement</span><span class="p">(</span><span class="s2">"ARG"</span><span class="p">)</span>
	<span class="n">restoreSegement</span><span class="p">(</span><span class="s2">"LCL"</span><span class="p">)</span>
	<span class="n">gotoReturnAddress</span><span class="p">()</span>
<span class="k">end</span>

<span class="c1"># 暂存return地址到R14（最后取return地址时需要用LCL-5来定位，而途中LCL会被修改，所以需要先把return地址暂存起来，R13被getStackTopToD占用了）</span>
<span class="k">def</span> <span class="nf">saveReturnAddress</span><span class="p">()</span> 
	<span class="n">asm_cmd</span> <span class="o">=</span> <span class="s2">"@5"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"D=A"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"@LCL"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"A=M-D"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"D=M"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"@R14"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"M=D"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="vi">@sam_file</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">asm_cmd</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># 重置SP指针</span>
<span class="k">def</span> <span class="nf">restoreSP</span><span class="p">()</span>
	<span class="n">asm_cmd</span> <span class="o">=</span> <span class="s2">"@ARG"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"D=M+1"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"@SP"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"M=D"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="vi">@sam_file</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">asm_cmd</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># 恢复寄存器指针</span>
<span class="k">def</span> <span class="nf">restoreSegement</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span> 
	<span class="n">table</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"THAT"</span><span class="o">=&gt;</span><span class="s2">"1"</span><span class="p">,</span> <span class="s2">"THIS"</span><span class="o">=&gt;</span><span class="s2">"2"</span><span class="p">,</span> <span class="s2">"ARG"</span><span class="o">=&gt;</span><span class="s2">"3"</span><span class="p">,</span> <span class="s2">"LCL"</span><span class="o">=&gt;</span><span class="s2">"4"</span><span class="p">}</span>
	<span class="n">asm_cmd</span> <span class="o">=</span> <span class="s2">"@</span><span class="si">#{</span><span class="n">table</span><span class="p">[</span><span class="n">segment</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"D=A"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"@LCL"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"A=M-D"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"D=M"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"@</span><span class="si">#{</span><span class="n">segment</span><span class="si">}</span><span class="s2">"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"M=D"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="vi">@sam_file</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">asm_cmd</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># return到上一级函数继续执行</span>
<span class="k">def</span> <span class="nf">gotoReturnAddress</span><span class="p">()</span> 
	<span class="n">asm_cmd</span> <span class="o">=</span> <span class="s2">"@R14"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"A=M"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="c1"># 从R14取出缓存的return地址</span>
	<span class="n">asm_cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">"0;JMP"</span><span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
	<span class="vi">@sam_file</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">asm_cmd</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="从中学到什么">从中学到什么</h3>

<p>通过本篇的实践，我们掌握了CPU在栈上的工作方式，尤其是了解了栈对函数调用的支持。这些指令和我们常用的CPU汇编指令更加接近（包括某些寄存器的作用），对我们进一步学习理解x86或ARM汇编指令，甚至C语言等高级语言会有很大帮助。</p>

<p>我们看到了程序虚拟机的工作方式，它本质上是一个翻译机：向上提供一种新的语言接口，然后把虚拟机语言翻译成所在平台的计算机语言，因此我们也可以在其它平台上实现Hack虚拟机，只不过翻译的实现细节会发生改变。Hack虚拟机和Java虚拟机本质上相同的，Hack虚拟机是一个纯的静态翻译器，而Java虚拟机作为一个进程运行，是动态翻译的，此外Java虚拟机还有类加载器，内存回收等强大功能。</p>

<p>我们也学到了一些重要的编程思想：如果在本层实现逻辑过于复杂，可以考虑把一些复杂的逻辑抽象出来，交给下层来实现，即把复杂的问题分层化。尽量让动态的，变化的，需要被编程的，面向程序员的部分变得标准和简单，把复杂的逻辑封装在静态的，底层的，不面向程序员的地方。目的是让开发者能把主要精力放在解决问题的算法之上，而不用考虑让人头疼的底层的实现细节。这是一个程序员的重要基本功。</p>

<center><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gc7ccatyh7j30z00sg45t.jpg" width="500" /></center>

<h3 id="next">NEXT</h3>

<p>Hack虚拟机更加接近一个真实的计算机了，它可以支持一系列函数在虚拟机上的运算和互相调用。下一篇我们将设计一门简洁的面向对象语言，并实现它的编译器，然后我们终于可以使用高级语言在Hack上编写程序了。</p>

<p>本篇完整实现放在了:<a href="https://github.com/guosainpu/Nand2Tetris">github</a></p>


                <hr style="visibility: hidden;">
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2020/02/19/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E4%B8%8E%E6%B1%87%E7%BC%96%E5%99%A8/" data-toggle="tooltip" data-placement="top" title="从0到1构建计算机(6/12)--汇编语言与汇编器">
                        Previous<br>
                        <span>从0到1构建计算机(6/12)--汇编语言与汇编器</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2020/02/24/%E9%AB%98%E7%BA%A7%E8%AF%AD%E8%A8%80-Jack/" data-toggle="tooltip" data-placement="top" title="从0到1构建计算机(8/12)--高级语言：Jack">
                        Next<br>
                        <span>从0到1构建计算机(8/12)--高级语言：Jack</span>
                        </a>
                    </li>
                    
                </ul>
                <hr style="visibility: hidden;">

                <!---->
                <!-- disqus 评论框 start -->
                <!--<div class="comment">-->
                <!--    <div id="disqus_thread" class="disqus-thread"></div>-->
                <!--</div>-->
                <!-- disqus 评论框 end -->
                <!---->

                <!---->
            </div>  

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                


<section>
    
        <hr class="hidden-sm hidden-xs">
    
    <h5><a href="/archive/">FEATURED TAGS</a></h5>
    <div class="tags">
        
        
        
        
        
        
                <a data-sort="0005" 
                    href="/archive/?tag=%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80"
                    title="计算机基础"
                    rel="18">计算机基础</a>
        
                <a data-sort="0011" 
                    href="/archive/?tag=%E4%BB%8E0%E5%88%B01%E6%9E%84%E5%BB%BA%E8%AE%A1%E7%AE%97%E6%9C%BA"
                    title="从0到1构建计算机"
                    rel="12">从0到1构建计算机</a>
        
                <a data-sort="0020" 
                    href="/archive/?tag=%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80"
                    title="汇编语言"
                    rel="3">汇编语言</a>
        
                <a data-sort="0020" 
                    href="/archive/?tag=%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A1%AC%E4%BB%B6%E4%BD%93%E7%B3%BB"
                    title="计算机硬件体系"
                    rel="3">计算机硬件体系</a>
        
                <a data-sort="0021" 
                    href="/archive/?tag=%E6%95%B0%E5%AD%A6%E5%9F%BA%E7%A1%80"
                    title="数学基础"
                    rel="2">数学基础</a>
        
                <a data-sort="0021" 
                    href="/archive/?tag=iOS"
                    title="iOS"
                    rel="2">iOS</a>
    </div>
</section>


                <!-- Friends Blog -->
                
            </div>
        </div>
    </div>
</article>

<!-- add support for mathjax by voleking-->






<!-- disqus 公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "hux";
    var disqus_identifier = "/2020/02/21/实现一个虚拟机";
    var disqus_url = "http://localhost:4000/2020/02/21/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E8%99%9A%E6%8B%9F%E6%9C%BA/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus 公共JS代码 end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'right',
          // icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>

</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Simple Jekyll Search -->
<script src="/js/simple-jekyll-search.min.js"></script>

<!-- Service Worker -->

<script src="/js/snackbar.js "></script>
<script src="/js/sw-registration.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
        var d = document, t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
        s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->







<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function () {
        var $nav = document.querySelector("nav");
        if ($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-49627206-1';
    var _gaDomain = 'huangxuan.me';

    // Originial
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
            m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>



<!-- Baidu Tongji -->



<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog(selector) {

        // interop with multilangual 
        if ('' == 'true') {
            _containerSelector = 'div.post-container.active'
        } else {
            _containerSelector = 'div.post-container'
        }

        // init
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        // clean
        $(selector).html('')

        // appending
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>



<!-- Multi-Lingual -->


<!-- Simple Jekyll Search -->
<script>
    // https://stackoverflow.com/questions/1912501/unescape-html-entities-in-javascript
    function htmlDecode(input) {
        var e = document.createElement('textarea');
        e.innerHTML = input;
        // handle case of empty input
        return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
    }

    SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('search-results'),
        json: '/search.json',
        searchResultTemplate: '<div class="post-preview item"><a href="{url}"><h2 class="post-title">{title}</h2><h3 class="post-subtitle">{subtitle}</h3><hr></a></div>',
        noResultsText: 'No results',
        limit: 50,
        fuzzy: false,
        // a hack to get escaped subtitle unescaped. for some reason, 
        // post.subtitle w/o escape filter nuke entire search.
        templateMiddleware: function (prop, value, template) {
            if (prop === 'subtitle' || prop === 'title') {
                if (value.indexOf("code")) {
                    return htmlDecode(value);
                } else {
                    return value;
                }
            }
        }
    });

    $(document).ready(function () {
        var $searchPage = $('.search-page');
        var $searchOpen = $('.search-icon');
        var $searchClose = $('.search-icon-close');
        var $searchInput = $('#search-input');
        var $body = $('body');

        $searchOpen.on('click', function (e) {
            e.preventDefault();
            $searchPage.toggleClass('search-active');
            var prevClasses = $body.attr('class') || '';
            setTimeout(function () {
                $body.addClass('no-scroll');
            }, 400)

            if ($searchPage.hasClass('search-active')) {
                $searchClose.on('click', function (e) {
                    e.preventDefault();
                    $searchPage.removeClass('search-active');
                    $body.attr('class', prevClasses);  // from closure 
                });
                $searchInput.focus();
            }
        });
    });
</script>


<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
